"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}Object.defineProperty(exports,"__esModule",{value:!0});var Pride=exports.Pride={};Pride.Util={},Pride.Core={},Pride.Settings={default_cache_size:20,cache_size:{},datastores_url:"",connection_attempts:3,init_attempts:3,ms_between_attempts:1500,message_formats:{failed_record_load:"Failed to load $1",failed_search_run:"Failed to search $1",failed_init:"Failed to initialize Pride"},obnoxious:!1};var _underscore=require("underscore");Pride.Core.Datastore=function(e){e=Pride.Util.deepClone(e),this.baseQuery=function(){return new Pride.Core.Query({uid:e.uid,sort:e.default_sort,start:0,count:0,settings:{},field_tree:r(),facets:_underscore._.reduce(e.facets,function(e,r){return r.required&&!r.fixed&&(e[r.uid]=r.default_value),e},{})})},this.baseSearch=function(){return new Pride.Core.DatastoreSearch({datastore:this})},this.runQuery=function(r){return r.url=e.url,Pride.Util.request(r),this},this.get=function(r){return e[r]},this.update=function(r){_underscore._.extend(e,r)};var r=function(r){r=r||new Pride.FieldTree.FieldBoolean("AND");var t=_underscore._.reduce(e.fields,function(e,r){return!r.required&&!r.fixed||e.contains({type:"field",value:r.uid})?e:(missing_field=new Pride.FieldTree.Field(r.uid,new Pride.FieldTree.Literal(r.default_value)),_underscore._.isMatch(e,{type:"field_boolean",value:"AND"})?e.addChild(missing_field):new Pride.FieldTree.FieldBoolean("AND",e,missing_field))},r);return t.matches({type:"field_boolean",children:[]})?{}:t}};var _underscore=require("underscore");Pride.Core.DatastoreSearch=function(e){var r=this,t=new Pride.Core.SearchBase(e,this);t.createItem=function(e){return new Pride.Core.Record(e)};var n=[],i=[];this.getFacets=function(){return n},this.uid=t.datastore.get("uid"),this.getData=function(){return{uid:r.uid,metadata:Pride.Util.deepClone(t.datastore.get("metadata")),sorts:Pride.Util.deepClone(t.datastore.get("sorts")),selected_sort:t.query.get("sort"),facets:Pride.Util.deepClone(t.query.get("facets")),fields:Pride.Util.deepClone(t.datastore.get("fields")),field_tree:Pride.Util.deepClone(t.query.get("field_tree")),settings:Pride.Util.deepClone(t.query.get("settings")),page:t.query.get("page"),count:t.query.get("count"),total_available:t.query.get("total_available"),total_pages:t.query.get("total_pages"),page_limit:t.query.get("page_limit")}},this.getResults=t.results,t.initialize_observables=function(){r.runDataObservers.add(function(){var e=t.datastore.get("facets");Pride.Util.isDeepMatch(i,e)||(_underscore._.each(n,function(e){e.clearAllObservers()}),n=_underscore._.map(e,function(e){return new Pride.Core.FacetSearch({data:_underscore._.omit(e,"values"),results:e.values})}),i=e,r.facetsObservers.notify())})},this.getMute=t.getMute,this.setMute=function(e){return _underscore._.each(n,function(r){r.setMute(e)}),t.setMute(e),r},t.createObservable("facets",this.getFacets).initialize_observables()};var _underscore=require("underscore");Pride.Core.FacetSearch=function(e){var r=e.data,t=e.results;this.uid=r.uid,this.getData=function(){return r},this.getResults=function(){return t};var n=!1;this.getMute=function(){return n},this.setMute=function(e){return n=e,self};var i=[];this.clearAllObservers=function(){return _underscore._.each(i,function(e){e.clearAll()}),self};var s=function(e,t){var n=new Pride.Util.FuncBuffer(function(){var n=this.add,s=this.call;i.push(this),this.add=function(e){return self.muted||e(t()),n(e,"observers"),this},this.notify=function(){return self.muted||(r=t(),self.log("NOTIFY ("+e+")",r),s("observers",r)),this}});return n};this.resultsObservers=s("results",this.getResults),this.setDataObservers=s("setData",this.getData),this.runDataObservers=s("runData",this.getData)};var _underscore=require("underscore");Pride.FieldTree={},Pride.Core.nodeFactory=function(e,r,t){return function(n){this.children=Pride.Util.slice(arguments,1),this.type=e,this.value=n.trim(),this.child_types=r||[],this.validIfEmpty=!0,this.addChild=function(e){if(!_underscore._.find(this.child_types,function(r){return e.type===r}))throw"Not a valid child for a "+this.type;return this.children.push(e),this},this.contains=function(e){return this.matches(e)?this:!_underscore._.isEmpty(this.children)&&_underscore._.find(this.children,function(r){return r.contains(e)})},this.matches=function(e){var r=this,t=e.children||[];return _underscore._.every(_underscore._.omit(e,"children"),function(e,t){return r[t]==e})&&_underscore._.every(t,function(e){return _underscore._.any(children,function(r){return e.matches(r)})})},this.serialize=function(){return n},this.serializedChildren=function(){return _underscore._.chain(this.children).map(function(e){return e.serialize()}).compact().value()},this.toJSON=function(){return _underscore._.pick(this,"value","children","type")},_underscore._.isFunction(t)&&t.call(this)}},Pride.Core.boolNodeFactory=function(e,r){return Pride.Core.nodeFactory(e,r,function(){if(!_underscore._.contains(["AND","OR","NOT"],this.value))throw"Not a valid boolean value";this.serialize=function(){return this.serializedChildren().join(" "+this.value+" ")},this.serializedChildren=function(){var e=this;return _underscore._.chain(e.children).map(function(r){return r.type==e.type||"literal"==r.type&&r.value.match(/\s/)?"("+r.serialize()+")":r.serialize()}).compact().value()}})};var top_level_nodes=["field_boolean","field"],inside_field_nodes=["value_boolean","literal","tag","special"];Pride.FieldTree.FieldBoolean=Pride.Core.boolNodeFactory("field_boolean",top_level_nodes),Pride.FieldTree.ValueBoolean=Pride.Core.boolNodeFactory("value_boolean",inside_field_nodes),Pride.FieldTree.Field=Pride.Core.nodeFactory("field",inside_field_nodes,function(){this.serialize=function(){return this.value+": ("+this.serializedChildren().join(" ")+")"}}),Pride.FieldTree.Tag=Pride.Core.nodeFactory("tag",inside_field_nodes,function(){this.serialize=function(){var e=this.serializedChildren();return 0===e.length?"":this.value+"("+e.join(" ")+")"}}),Pride.FieldTree.Literal=Pride.Core.nodeFactory("literal"),Pride.FieldTree.Special=Pride.Core.nodeFactory("special");var _underscore=require("underscore");Pride.Util.FuncBuffer=function(e){var r={},t=this,n=function(e){return _underscore._.has(r,e)||(r[e]=[]),r[e]};this.add=function(e,r){return n(r).push(e),t},this.remove=function(e,i){return r[i]=_underscore._.reject(n(i),function(r){return e==r}),t},this.clear=function(e){return delete r[e],t},this.clearAll=function(){return r={},t},this.call=function(e){return t.apply(e,Pride.Util.slice(arguments,1)),t},this.apply=function(e,r){return _underscore._.each(n(e),function(e){Pride.Util.safeApply(e,r)}),t},_underscore._.isFunction(e)&&e.call(this)};var _underscore=require("underscore");Pride.Core.Holdings=function(e){this.data=e;var r=function(e){var r;return _underscore._.each(e.fields,function(e){"holdings_url"===e.uid&&(r=e.value)}),r},t=function(e){var r;return _underscore._.each(e.fields,function(e){"links"==e.uid&&(r=e.value)}),r},n=new Pride.Util.RequestBuffer({url:r(e),failure_message:Pride.Messenger.preset("failed_holdings_load",e.names[0]),edit_response:function(r){return e=i(r)}}),i=function(r){return _underscore._.each(t(e),function(e){var t={type:"online"};_underscore._.each(e,function(e){e.value.constructor==Array&&1==e.value.length?t[e.name]=e.value[0]:t[e.name]=e.value}),r.push(t)}),r};this.getData=function(e){n.request({success:e})}};var _underscore=require("underscore");Pride.Util.MultiSearch=function(e,r,t){var n={},i=this;this.searches=t,this.uid=e,this.set=function(e){return _underscore._.extend(n,e),_underscore._.each(t,function(r){r.set(e)}),i};var s=function(e,r){return function(){var n=Pride.Util.slice(arguments);return Pride.Util.safeApply(r,n),_underscore._.each(t,function(r){r[e].apply(r,n)}),i}};this.run=s("run"),this.nextPage=s("nextPage"),this.prevPage=s("prevPage"),this.setMute=s("setMute",function(e){r=e}),this.getMute=function(){return r},this.setMute(r)};var _underscore=require("underscore");Pride.Util.Paginater=function(e){this.set=function(e){if(_underscore._.has(e,"total_pages"))throw"Can not set total_pages (it is a calculated value)";if(_underscore._.has(e,"index_limit"))throw"Can not set index_limit (it is a calculated value)";if(_underscore._.intersection(["start","end","count"],_underscore._.keys(e)).length>2)throw"Can not set start, end and count all at the same time";if(_underscore._.has(e,"page")&&(_underscore._.has(e,"start")||_underscore._.has(e,"end")))throw"Can not set page as well as the start and/or end";if(_underscore._.extend(r,_underscore._.omit(e,"end")),_underscore._.has(e,"page")&&(r.start=(r.count||0)*(r.page-1)),_underscore._.has(e,"end")){if(_underscore._.has(e,"count"))r.start=Math.max(0,e.end-(r.count-1));else{if(!(r.start<=e.end))throw"The start value can not be greater than the end value";r.count=e.end-r.start+1}r.end=e.end}else{var t=r.start+r.count-1;r.end=t<r.start?void 0:t}if(_underscore._.isNumber(r.total_available)?r.total_available>0?r.index_limit=r.total_available-1:r.index_limit=void 0:r.index_limit=1/0,r.count>0&&r.start%r.count===0?(r.page=Math.floor(r.start/r.count)+1,_underscore._.isNumber(r.total_available)?(r.total_pages=Math.ceil(r.total_available/r.count),r.page_limit=r.total_pages):(r.total_pages=void 0,r.page_limit=1/0)):(r.page=void 0,r.total_pages=void 0,r.page_limit=void 0),!_underscore._.has(r,"start")||!_underscore._.has(r,"count"))throw"Not enough information given to create Paginater";return this},this.get=function(e){return r[e]};var r={};this.set(e)},Pride.Util.Paginater.getPossibleKeys=function(){return["start","count","end","page","index_limit","total_pages","total_available","page_limit"]},Pride.Util.Paginater.hasKey=function(e){return Pride.Util.Paginater.getPossibleKeys().indexOf(e)>-1};var _underscore=require("underscore");Pride.Core.Query=function(e){var r=new Pride.Util.Paginater({start:e.start,count:e.count}),t=Pride.Util.Paginater.getPossibleKeys();e=_underscore._.omit(Pride.Util.deepClone(e),t),e.request_id=e.request_id||0,this.get=function(t){return Pride.Util.Paginater.hasKey(t)?r.get(t):e[t]},this.set=function(n){var i=_underscore._.pick(n,t),s=_underscore._.omit(n,t);return _underscore._.isEmpty(s)||(r.set({total_available:void 0}),_underscore._.isNumber(s.request_id)||(e.request_id+=1)),r.set(i),_underscore._.extend(e,s),this},this.clone=function(){var t=Pride.Util.deepClone(e);return t.start=r.get("start"),t.count=r.get("count"),new Pride.Core.Query(t)},this.toSection=function(){return new Pride.Util.Section(this.get("start"),this.get("end"))},this.toLimitSection=function(){return new Pride.Util.Section(this.get("start"),this.get("index_limit"))},this.toJSON=function(){return{uid:this.get("uid"),request_id:this.get("request_id"),start:this.get("start"),count:this.get("count"),field_tree:this.get("field_tree"),facets:this.get("facets"),sort:this.get("sort"),settings:this.get("settings")}}};var _underscore=require("underscore");Pride.Core.Record=function(e){var r=new Pride.Util.RequestBuffer({url:e.source,failure_message:Pride.Messenger.preset("failed_record_load",e.names[0]),edit_response:function(r){return e=i(r)}}),t=null;this.getHoldings=function(n){t?t.getData(n):e.complete?(t=new Pride.Core.Holdings(e),t.getData(n)):r.request({success:function(e){t=new Pride.Core.Holdings(e),t.getData(n)}})},this.renderPart=function(e){n(e)},this.renderPartThenCache=function(e){n(e),r.request()},this.renderFull=function(t){e.complete?n(t):r.request({success:t})};var n=function(r){r(_underscore._.omit(e,"complete","source"),e.complete)},i=function(e){return e.fields=_underscore._.map(e.fields,function(e){return e.value_has_html||(e.value=Pride.Util.escape(e.value)),_underscore._.omit(e,"value_has_html")}),e.names_have_html||(e.names=_underscore._.map(e.names,function(e){return Pride.Util.escape(e)})),_underscore._.omit(e,"names_have_html")};e=i(e)};var _underscore=require("underscore");Pride.Util.RequestBuffer=function(e){e=e||{};var r,t=new Pride.Util.FuncBuffer,n=!1,i=!1,s=!1;this.request=function(e){return t.add(e.success,"success").add(e.failure,"failure"),n?u():a(),this};var u=function(e){r=e||r,i?o("success"):s&&o("failure")},a=function(){n=!0,Pride.Util.request({url:Pride.Util.safeCall(e.url),attempts:Pride.Util.safeCall(e.attempts)||Pride.Settings.connection_attempts,failure_message:Pride.Util.safeCall(e.failure_message),failure:function(r){s=!0,Pride.Util.safeCall(e.before_failure,r),u(r),Pride.Util.safeCall(e.after_failure,r)},success:function(r){i=!0,Pride.Util.safeCall(e.before_success,r),_underscore._.isFunction(e.edit_response)&&(r=e.edit_response(r)),u(r),Pride.Util.safeCall(e.after_success,r)}})},o=function(e){t.call(e,r).clearAll()}};var _underscore=require("underscore");Pride.Core.SearchBase=function(e,r){this.datastore=e.datastore,this.query=e.query||this.datastore.baseQuery();var t=this,n=e.requestFunc||this.datastore.runQuery,i=e.starting_results||[],s=e.cache_size||Pride.Settings.cache_size[this.datastore.uid]||Pride.Settings.default_cache_size;this.log=function(){var e=Pride.Util.slice(arguments);e.unshift("Search ("+t.datastore.get("uid")+")"),Pride.Core.log.apply(window,e)},this.set=function(e){return t.query.set(e),Pride.Util.safeCall(t.setDataChanged),_underscore._.isEmpty(_underscore._.omit(e,Pride.Util.Paginater.getPossibleKeys()))||(i=[]),t},this.run=function(e){return Pride.Util.safeCall(t.resultsChanged),_underscore._.isUndefined(e)&&(e=s),u(c(t.query.toSection().expanded(e))),t},this.results=function(){return d(new Pride.Util.Section(t.query.get("start"),Math.min(t.query.get("end"),t.query.get("index_limit"))))};var u=function e(r){if(t.log("REQUESTING",r),t.log("TOTAL AVAILABLE (pre-request)",t.query.get("total_available")),r&&t.query.toLimitSection().overlaps(r)){t.log("Sending query...");var i=t.query.clone().set({start:r.start,count:r.calcLength()});n({query:i,failure_message:Pride.Messenger.preset("failed_search_run",t.datastore.get("metadata").name),success:function(n){if(n.request.request_id==t.query.get("request_id")){o(n),a(n.response,i.get("start"));var s=n.response.length;0!==s&&s<i.get("count")&&e(r.shifted(s,0))}}})}else Pride.Util.safeCall(t.runDataChanged)},a=function(e,r){var n=!1;t.log("NEW RECORDS",e),_underscore._.each(e,function(e,s){var u=s+r;_underscore._.isUndefined(i[u])&&(i[u]=Pride.Util.safeCall(t.createItem,e),t.query.toSection().inSection(u)&&(n=!0))}),t.log("CACHE LENGTH",i.length),(n||_underscore._.isEmpty(e))&&Pride.Util.safeCall(t.resultsChanged)},o=function(e){t.datastore.update(e.datastore);var r=_underscore._.omit(e.new_request,"start","count");r.total_available=e.total_available,t.query.set(r),Pride.Util.safeCall(t.runDataChanged)},c=function(e){var r=d(e),t=_underscore._.indexOf(r,void 0);if(t!=-1){var n=e.start+_underscore._.lastIndexOf(r,void 0);return t+=e.start,new Pride.Util.Section(t,n)}},d=function(e){for(var r=[],t=e.start;t<=e.end;t++)r.push(i[t]);return r},l=!1,f=[],h=[];this.clearAllObservers=function(){return _underscore._.each(f,function(e){e.clearAll()}),Pride.Util.safeCall(t.initialize_observables),t},this.getMute=function(){return l},this.setMute=function(e){return e!=l&&(l=e,Pride.Util.safeCall(t.muteChanged()),l||_underscore._.each(h,function(e){e.notify()})),t},this.createObservable=function(e,n,i){var s=new Pride.Util.FuncBuffer(function(){var r=this.add,s=this.call;f.push(this),i||h.push(this),this.add=function(e){return t.muted&&!i||e(n()),r(e,"observers"),this},this.notify=function(){if(!t.muted||i){var r=n();t.log("NOTIFY ("+e+")",r),s("observers",r)}return this}});return t[e+"Changed"]=s.notify,r[e+"Observers"]=s,t},this.createObservable("mute",this.getMute,!0).createObservable("setData",function(){r.getData()}).createObservable("runData",function(){r.getData()}).createObservable("results",this.results),r.set=function(e){return t.set(e),r},r.run=function(e){return t.run(e),r},r.nextPage=function(e){var n=t.query.get("page");return _underscore._.isNumber(n)&&n<t.query.get("page_limit")&&(r.set({page:n+1}),r.run(e)),r},r.prevPage=function(e){var n=t.query.get("page");return _underscore._.isNumber(n)&&n>1&&(r.set({page:n-1}),r.run(e)),r}};var _underscore=require("underscore");Pride.Util.SearchSwitcher=function(e,r){var t=this,n=new Pride.Util.MultiSearch(null,(!0),r);e.set({page:1}).setMute(!1),n.set({page:1}),this.uid=e.uid,this.run=function(r){return e.run(r),n.run(0),t},this.set=function(r){return e.set(r),n.set(_underscore._.omit(r,"page","facets")),t},this.nextPage=function(){return e.nextPage(),t},this.prevPage=function(){return e.prevPage(),t},this.switchTo=function(r){if(r!=e){if(e.setMute(!0).set({page:1}),n.searches.push(e),e=void 0,n.searches=_underscore._.reject(n.searches,function(t){if(t.uid==r)return e=t,!0}),!e)throw"Could not find a search with a UID of: "+r;t.uid=e.uid,e.setMute(!1)}return t}};var _underscore=require("underscore");Pride.Util.Section=function(e,r){this.start=Math.max(Math.min(e,r),0),this.end=Math.max(Math.max(e,r),0),this.inSection=function(e){return e>=this.start&&e<=this.end},this.overlaps=function(e){return this.inSection(e.start)||this.inSection(e.end)},this.calcLength=function(){return this.end-this.start+1},this.expanded=function(e){return this.shifted(-1*e,e)},this.shifted=function(e,r){return _underscore._.isNumber(r)||(r=e),new Pride.Util.Section(this.start+e,this.end+r)}};var _underscore=require("underscore");Pride.Util.deepClone=function(e){if(_underscore._.isFunction(e))return e;var r=!1;return _underscore._.isArray(e)?r="map":_underscore._.isObject(e)&&(r="mapObject"),r?_underscore._[r](e,function(e){return Pride.Util.deepClone(e)}):_underscore._.clone(e)},Pride.Util.escape=function(e){var r=document.createElement("div");return r.appendChild(document.createTextNode(e)),r.innerHTML};var _underscore=require("underscore");Pride.init=new Pride.Util.RequestBuffer({url:function(){return Pride.Settings.datastores_url},attempts:function(){return Pride.Settings.init_attempts},failure_message:function(){return Pride.Messenger.preset("failed_init")},edit_response:function(){},before_success:function(e){Pride.AllDatastores.array=_underscore._.map(e.response,function(e){return new Pride.Core.Datastore(e)})}}).request;var _underscore=require("underscore");Pride.Util.isDeepMatch=function(e,r){var t=_underscore._.isArray(e)&&_underscore._.isArray(r),n=_underscore._.isObject(e)&&_underscore._.isObject(r);return(!t||r.length==e.length)&&((!n||_underscore._.keys(r).length==_underscore._.keys(e).length)&&(t||n?_underscore._.every(r,function(r,t){return Pride.Util.isDeepMatch(e[t],r)}):e===r))},Pride.Core.log=function(e,r){if(Pride.Settings.obnoxious){var t=Pride.Util.slice(arguments,2);t.unshift("[Pride: "+e+"] "+r),console.log.apply(console,t)}},Pride.FieldTree.parseField=function(e,r){if(!r)return{};try{return Pride.Parser.parse(r,{defaultFieldName:e})}catch(t){return console.log(t),new Pride.FieldTree.Field(e,new Pride.FieldTree.Literal(r))}};var _underscore=require("underscore");Pride.FieldTree=Pride.FieldTree||{},Pride.FieldTree.tokens=[":","AND","OR","+","-","(",")","*"," ","\n","\t","\r"],Pride.FieldTree.tokenize=function(e){for(var r=[],t=0,n=null;t<e.length;){var i=e.slice(t),s=_underscore._.find(Pride.FieldTree.tokens,function(e){return new RegExp("^\\"+e).exec(i)});if(s)/\s/.exec(s)&&(n="whitespace"),n=s,t+=s.length;else{s=e.charAt(t),n="string",t++;var u=_underscore._.last(r);u&&"string"==u.type&&(s=r.pop().content+s)}r.push({type:n,content:s})}return r};var _underscore=require("underscore"),_reqwest=require("reqwest"),_reqwest2=_interopRequireDefault(_reqwest);Pride.Util.request=function(e){if(Pride.Core.log("Request","Sending HTTP request..."),Pride.Core.log("Request","URL",e.url),Pride.Core.log("Request","CONTENT",JSON.stringify(e.query)),!e.url)throw"No URL given to Pride.Util.request()";var r="get";e.query&&(r="post"),_underscore._.isNumber(e.attempts)||(e.attempts=Pride.Settings.connection_attempts),e.attempts-=1,(0,_reqwest2.default)({url:e.url,data:JSON.stringify(e.query),type:"json",method:r,contentType:"application/json",withCredentials:!0,error:function(r){e.attempts<=0?(Pride.Core.log("Request","ERROR",r),Pride.Util.safeCall(e.failure,r),Pride.Messenger.sendMessage({summary:e.failure_message,class:"error"})):(Pride.Core.log("Request","Trying request again..."),window.setTimeout(function(){Pride.Util.request(e)},Pride.Settings.ms_between_attempts))},success:function(r){Pride.Core.log("Request","SUCCESS",r),Pride.Util.safeCall(e.success,r),Pride.Messenger.sendMessage({summary:e.success_message,class:"success"}),Pride.Messenger.sendMessageArray(r.messages)}})},Pride.requestRecord=function(e,r,t){void 0===t&&(t=function(e){});var n={complete:!1,source:Pride.AllDatastores.get(e).get("url")+"/record/"+r,names:[void 0]},i=new Pride.Core.Record(n);return i.renderFull(t),i};var _underscore=require("underscore");Pride.Util.safeCall=function(e){return _underscore._.isFunction(e)?e.apply(this,Pride.Util.slice(arguments,1)):e},Pride.Util.safeApply=function(e,r){return _underscore._.isFunction(e)?e.apply(this,r):e},Pride.Util.slice=function(e,r,t){return Array.prototype.slice.call(e,r,t)};var _underscore=require("underscore");Pride.AllDatastores={array:[],get:function(e){return _underscore._.find(this.array,function(r){return r.get("uid")==e})},newSearch:function(e){var r=_underscore._.find(this.array,function(r){return r.get("uid")==e});return r?r.baseSearch():void 0},each:function(e){return _underscore._.each(this.array,e),this}},Pride.Messenger=new Pride.Util.FuncBuffer(function(){this.call;this.addObserver=this.add,this.removeObserver=this.remove,this.clearObservers=this.clear,this.call=void 0,this.add=void 0,this.remove=void 0,this.clear=void 0,this.sendMessage=function(e){},this.sendMessageArray=function(e){},this.preset=function(e){}}),Pride.Parser=function(){function e(e,r){function t(){this.constructor=e}t.prototype=r.prototype,e.prototype=new t}function r(e,t,n,i){this.message=e,this.expected=t,this.found=n,this.location=i,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,r)}function t(e,t){function n(e,r){return{type:"literal",text:e,ignoreCase:r}}function i(e,r,t){return{type:"class",parts:e,inverted:r,ignoreCase:t}}function s(){return{type:"end"}}function u(e){return{type:"other",description:e}}function a(r){var t,n=ve[r];if(n)return n;for(t=r-1;!ve[t];)t--;for(n=ve[t],n={line:n.line,column:n.column};t<r;)10===e.charCodeAt(t)?(n.line++,n.column=1):n.column++,t++;return ve[r]=n,n}function o(e,r){var t=a(e),n=a(r);return{start:{offset:e,line:t.line,column:t.column},end:{offset:r,line:n.line,column:n.column}}}function c(e){ge<Pe||(ge>Pe&&(Pe=ge,me=[]),me.push(e))}function d(e,t,n){return new r(r.buildMessage(e,t),e,t,n)}function l(){var e;return e=f()}function f(){var e,r,t,n,i,s;return e=ge,r=g(),r!==T?(t=S(),t!==T?(n=y(),n!==T?(i=S(),i!==T?(s=f(),s!==T?(pe=e,r=N(r,n,s),e=r):(ge=e,e=T)):(ge=e,e=T)):(ge=e,e=T)):(ge=e,e=T)):(ge=e,e=T),e===T&&(e=h()),e}function h(){var e,r,t;return e=g(),e===T&&(e=ge,r=g(),r!==T?(t=_(),t===T&&(t=null),t!==T?(pe=e,r=R(r,t),e=r):(ge=e,e=T)):(ge=e,e=T)),e}function _(){var e,r,t;return e=ge,r=S(),r!==T?(t=h(),t!==T?(pe=e,r=E(t),e=r):(ge=e,e=T)):(ge=e,e=T),e}function g(){var r,t,n,i;return r=ge,t=p(),t!==T?(58===e.charCodeAt(ge)?(n=z,ge++):(n=T,0===ye&&c(j)),n!==T?(i=v(),i!==T?(pe=r,t=B(t,i),r=t):(ge=r,r=T)):(ge=r,r=T)):(ge=r,r=T),r===T&&(r=ge,t=v(),t!==T&&(pe=r,t=L(t)),r=t),r}function p(){var e,r,t;if(e=ge,r=[],t=w(),t!==T)for(;t!==T;)r.push(t),t=w();else r=T;return r!==T&&(pe=e,r=k(r)),e=r}function v(){var e,r,t;return e=ge,r=m(),r!==T?(t=P(),t===T&&(t=null),t!==T?(pe=e,r=I(r,t),e=r):(ge=e,e=T)):(ge=e,e=T),e}function P(){var e,r,t;return e=ge,r=S(),r!==T?(t=v(),t!==T?(pe=e,r=E(t),e=r):(ge=e,e=T)):(ge=e,e=T),e}function m(){var e,r,t,n,i;if(e=ge,r=ge,ye++,t=C(),ye--,t===T?r=void 0:(ge=r,r=T),r!==T)if(t=x(),t!==T){if(n=[],i=A(),i!==T)for(;i!==T;)n.push(i),i=A();else n=T;n!==T?(pe=e,r=H(t,n),e=r):(ge=e,e=T)}else ge=e,e=T;else ge=e,e=T;if(e===T){if(e=ge,r=ge,ye++,t=C(),ye--,t===T?r=void 0:(ge=r,r=T),r!==T){if(t=[],n=x(),n!==T)for(;n!==T;)t.push(n),n=x();else t=T;t!==T?(pe=e,r=Q(t),e=r):(ge=e,e=T)}else ge=e,e=T;if(e===T){if(e=ge,r=q(),r!==T){for(t=[],n=b();n!==T;)t.push(n),n=b();t!==T?(n=q(),n!==T?(pe=e,r=K(t),e=r):(ge=e,e=T)):(ge=e,e=T)}else ge=e,e=T;if(e===T)if(e=ge,r=U(),r!==T){for(t=[],n=F();n!==T;)t.push(n),n=F();t!==T?(n=U(),n!==T?(pe=e,r=K(t),e=r):(ge=e,e=T)):(ge=e,e=T)}else ge=e,e=T}}return e}function y(){var e,r;return e=ge,r=C(),r!==T&&(pe=e,r=J(r)),e=r}function C(){var r;return e.substr(ge,3)===G?(r=G,ge+=3):(r=T,0===ye&&c(V)),r===T&&(e.substr(ge,2)===Y?(r=Y,ge+=2):(r=T,0===ye&&c($)),r===T&&(e.substr(ge,3)===W?(r=W,ge+=3):(r=T,0===ye&&c(X)))),r}function q(){var r;return 39===e.charCodeAt(ge)?(r=Z,ge++):(r=T,0===ye&&c(ee)),r}function b(){var r;return re.test(e.charAt(ge))?(r=e.charAt(ge),ge++):(r=T,0===ye&&c(te)),r}function U(){var r;return 34===e.charCodeAt(ge)?(r=ne,ge++):(r=T,0===ye&&c(ie)),r}function F(){var r;return se.test(e.charAt(ge))?(r=e.charAt(ge),ge++):(r=T,0===ye&&c(ue)),r}function w(){var r;return ae.test(e.charAt(ge))?(r=e.charAt(ge),ge++):(r=T,0===ye&&c(oe)),r}function A(){var r;return ce.test(e.charAt(ge))?(r=e.charAt(ge),ge++):(r=T,0===ye&&c(de)),r}function x(){var r;return le.test(e.charAt(ge))?(r=e.charAt(ge),ge++):(r=T,0===ye&&c(fe)),r}function S(){var r,t;if(r=[],he.test(e.charAt(ge))?(t=e.charAt(ge),ge++):(t=T,0===ye&&c(_e)),t!==T)for(;t!==T;)r.push(t),he.test(e.charAt(ge))?(t=e.charAt(ge),ge++):(t=T,0===ye&&c(_e));else r=T;return r}t=void 0!==t?t:{};var M,T={},O={start:l},D=l,N=function(e,r,t){return new Pride.FieldTree.FieldBoolean(r,e,t)},R=function(e,r){return r?[e,r]:e},E=function(e){return e},z=":",j=n(":",!1),B=function(e,r){return new(Function.prototype.bind.apply(Pride.FieldTree.Field,[null].concat([e],_toConsumableArray(r))))},L=function(e){return new(Function.prototype.bind.apply(Pride.FieldTree.Field,[null].concat([Ce],_toConsumableArray(e))))},k=function(e){return e.join("")},I=function(e,r){return r?e.concat(r):e},H=function(e,r){return[new Pride.FieldTree.Literal(e+r.join(""))]},Q=function(e){return[new Pride.FieldTree.Literal(e.join(""))]},K=function(e){return[new Pride.FieldTree.Literal(e.join(""))]},J=function(e){return e},G="AND",V=n("AND",!1),Y="OR",$=n("OR",!1),W="NOT",X=n("NOT",!1),Z="'",ee=n("'",!1),re=/^[^']/,te=i(["'"],!0,!1),ne='"',ie=n('"',!1),se=/^[^"]/,ue=i(['"'],!0,!1),ae=/^[^ \t\r\n:'"()]/,oe=i([" ","\t","\r","\n",":","'",'"',"(",")"],!0,!1),ce=/^[^ \t\r\n():]/,de=i([" ","\t","\r","\n","(",")",":"],!0,!1),le=/^[^ \t\r\n'"():]/,fe=i([" ","\t","\r","\n","'",'"',"(",")",":"],!0,!1),he=/^[ \t\r\n]/,_e=i([" ","\t","\r","\n"],!1,!1),ge=0,pe=0,ve=[{line:1,column:1}],Pe=0,me=[],ye=0;if("startRule"in t){if(!(t.startRule in O))throw new Error("Can't start parsing from rule \""+t.startRule+'".');D=O[t.startRule]}var Ce=t.defaultFieldName||"all_fields";if(M=D(),M!==T&&ge===e.length)return M;throw M!==T&&ge<e.length&&c(s()),d(me,Pe<e.length?e.charAt(Pe):null,Pe<e.length?o(Pe,Pe+1):o(Pe,Pe))}return e(r,Error),r.buildMessage=function(e,r){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}function n(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+t(e)})}function i(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+t(e)})}function s(e){return o[e.type](e)}function u(e){var r,t,n=new Array(e.length);for(r=0;r<e.length;r++)n[r]=s(e[r]);if(n.sort(),n.length>0){for(r=1,t=1;r<n.length;r++)n[r-1]!==n[r]&&(n[t]=n[r],t++);n.length=t}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}function a(e){return e?'"'+n(e)+'"':"end of input"}var o={literal:function(e){return'"'+n(e.text)+'"'},class:function(e){var r,t="";for(r=0;r<e.parts.length;r++)t+=e.parts[r]instanceof Array?i(e.parts[r][0])+"-"+i(e.parts[r][1]):i(e.parts[r]);return"["+(e.inverted?"^":"")+t+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};return"Expected "+u(e)+" but "+a(r)+" found."},{SyntaxError:r,parse:t}}();