"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Pride=exports.Pride={};Pride.Util={},Pride.Core={},Pride.Settings={default_cache_size:20,cache_size:{},datastores_url:"",connection_attempts:3,init_attempts:3,ms_between_attempts:1500,message_formats:{failed_record_load:"Failed to load $1",failed_search_run:"Failed to search $1",failed_init:"Failed to initialize Pride"},obnoxious:!1};var _underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.Datastore=function(t){t=Pride.Util.deepClone(t),this.baseQuery=function(){return new Pride.Core.Query({uid:t.uid,sort:t.default_sort,start:0,count:0,settings:{},field_tree:e(),facets:_underscore2.default.reduce(t.facets,function(e,t){return t.required&&!t.fixed&&(e[t.uid]=t.default_value),e},{})})},this.baseSearch=function(){return new Pride.Core.DatastoreSearch({datastore:this})},this.runQuery=function(e){return e.url=t.url,Pride.Util.request(e),this},this.get=function(e){return t[e]},this.update=function(e){_underscore2.default.extend(t,e)};var e=function(e){e=e||new Pride.FieldTree.FieldBoolean("AND");e=_underscore2.default.reduce(t.fields,function(e,t){return!t.required&&!t.fixed||e.contains({type:"field",value:t.uid})?e:(missing_field=new Pride.FieldTree.Field(t.uid,new Pride.FieldTree.Literal(t.default_value)),_underscore2.default.isMatch(e,{type:"field_boolean",value:"AND"})?e.addChild(missing_field):new Pride.FieldTree.FieldBoolean("AND",e,missing_field))},e);return e.matches({type:"field_boolean",children:[]})?{}:e}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.DatastoreSearch=function(e){var r=this,i=new Pride.Core.SearchBase(e,this);i.createItem=function(e){return new Pride.Core.Record(e)};var n=[],t=[];this.getFacets=function(){return n},this.uid=i.datastore.get("uid"),this.getData=function(){return{uid:r.uid,metadata:Pride.Util.deepClone(i.datastore.get("metadata")),sorts:Pride.Util.deepClone(i.datastore.get("sorts")),selected_sort:i.query.get("sort"),facets:Pride.Util.deepClone(i.query.get("facets")),fields:Pride.Util.deepClone(i.datastore.get("fields")),field_tree:Pride.Util.deepClone(i.query.get("field_tree")),settings:Pride.Util.deepClone(i.query.get("settings")),page:i.query.get("page"),count:i.query.get("count"),total_available:i.query.get("total_available"),total_pages:i.query.get("total_pages"),page_limit:i.query.get("page_limit"),specialists:Pride.Util.deepClone(i.query.get("specialists"))}},this.getResults=i.results,i.initialize_observables=function(){r.runDataObservers.add(function(){var e=i.datastore.get("facets");Pride.Util.isDeepMatch(t,e)||(_underscore2.default.each(n,function(e){e.clearAllObservers()}),n=_underscore2.default.map(e,function(e){return new Pride.Core.FacetSearch({data:_underscore2.default.omit(e,"values"),results:e.values})}),t=e,r.facetsObservers.notify())})},this.getMute=i.getMute,this.setMute=function(t){return _underscore2.default.each(n,function(e){e.setMute(t)}),i.setMute(t),r},i.createObservable("facets",this.getFacets).initialize_observables()};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.FacetSearch=function(e){var n=e.data,t=e.results;this.uid=n.uid,this.getData=function(){return n};var r=!(this.getResults=function(){return t});this.getMute=function(){return r},this.setMute=function(e){return r=e,self};var u=[];this.clearAllObservers=function(){return _underscore2.default.each(u,function(e){e.clearAll()}),self};e=function(r,i){return new Pride.Util.FuncBuffer(function(){var t=this.add,e=this.call;u.push(this),this.add=function(e){return self.muted||e(i()),t(e,"observers"),this},this.notify=function(){return self.muted||(n=i(),self.log("NOTIFY ("+r+")",n),e("observers",n)),this}})};this.resultsObservers=e("results",this.getResults),this.setDataObservers=e("setData",this.getData),this.runDataObservers=e("runData",this.getData)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.FieldTree={},Pride.Core.nodeFactory=function(t,r,i){return function(e){this.children=Pride.Util.slice(arguments,1),1===this.children.length&&Array.isArray(this.children[0])&&(this.children=this.children[0]),this.type=t,this.value=e.trim(),this.child_types=r||[],this.validIfEmpty=!0,this.addChild=function(t){if(!_underscore2.default.find(this.child_types,function(e){return t.type===e}))throw"Not a valid child for a "+this.type;return this.children.push(t),this},this.contains=function(t){return this.matches(t)?this:!_underscore2.default.isEmpty(this.children)&&_underscore2.default.find(this.children,function(e){return e.contains(t)})},this.matches=function(e){var r=this,t=e.children||[];return _underscore2.default.every(_underscore2.default.omit(e,"children"),function(e,t){return r[t]==e})&&_underscore2.default.every(t,function(t){return _underscore2.default.any(children,function(e){return t.matches(e)})})},this.serialize=function(){return e},this.serializedChildren=function(){return _underscore2.default.chain(this.children).map(function(e){return e.serialize()}).compact().value()},this.toJSON=function(){return _underscore2.default.mapObject(_underscore2.default.pick(this,"value","children","type"),function(e,t){return"children"==t?_underscore2.default.map(e,function(e){return e.toJSON()}):e})},_underscore2.default.isFunction(i)&&i.call(this)}},Pride.Core.boolNodeFactory=function(e,t){return Pride.Core.nodeFactory(e,t,function(){if(!_underscore2.default.contains(["AND","OR","NOT"],this.value))throw"Not a valid boolean value";this.serialize=function(){return this.serializedChildren().join(" "+this.value+" ")},this.serializedChildren=function(){var t=this;return _underscore2.default.chain(t.children).map(function(e){return e.type==t.type||"literal"==e.type&&e.value.match(/\s/)?"("+e.serialize()+")":e.serialize()}).compact().value()}})};var top_level_nodes=["field_boolean","field"],inside_field_nodes=["value_boolean","literal","tag","special"];Pride.FieldTree.FieldBoolean=Pride.Core.boolNodeFactory("field_boolean",top_level_nodes),Pride.FieldTree.ValueBoolean=Pride.Core.boolNodeFactory("value_boolean",inside_field_nodes),Pride.FieldTree.Field=Pride.Core.nodeFactory("field",inside_field_nodes,function(){this.serialize=function(){return this.value+": ("+this.serializedChildren().join(" ")+")"}}),Pride.FieldTree.Tag=Pride.Core.nodeFactory("tag",inside_field_nodes,function(){this.serialize=function(){var e=this.serializedChildren();return 0===e.length?"":this.value+"("+e.join(" ")+")"}}),Pride.FieldTree.Literal=Pride.Core.nodeFactory("literal"),Pride.FieldTree.Special=Pride.Core.nodeFactory("special"),Pride.FieldTree.Raw=Pride.Core.nodeFactory("raw");_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.FuncBuffer=function(e){function r(e){return _underscore2.default.has(i,e)||(i[e]=[]),i[e]}var i={},n=this;this.add=function(e,t){return r(t).push(e),n},this.remove=function(t,e){return i[e]=_underscore2.default.reject(r(e),function(e){return t==e}),n},this.clear=function(e){return delete i[e],n},this.clearAll=function(){return i={},n},this.call=function(e){return n.apply(e,Pride.Util.slice(arguments,1)),n},this.apply=function(e,t){return _underscore2.default.each(r(e),function(e){Pride.Util.safeApply(e,t)}),n},_underscore2.default.isFunction(e)&&e.call(this)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.GetThis=function(e,t){this.barcode=e,this.data=t;var r,i,n=new Pride.Util.RequestBuffer({url:(r=t,_underscore2.default.each(r.fields,function(e){"get_this_url"===e.uid&&(i=e.value)}),i+"/"+this.barcode),failure_message:Pride.Messenger.preset("failed_get_this_load",t.names[0]),edit_response:function(e){return t=u(e)}}),u=function(e){return e};this.getData=function(e){n.request({success:e})}},Pride.Core.Holdings=function(t){this.data=t;this.getData=function(e){Pride.Util.safeCall(e,(e=this.data.holdings,[function(e){e=e.fields.find(function(e){return"resource_access"===e.uid});return e&&e.value?e.value:e}(t)].concat(e)))}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.MultiSearch=function(e,t,i){var r={},n=this;this.searches=i,this.uid=e,this.set=function(t){return _underscore2.default.extend(r,t),_underscore2.default.each(i,function(e){e.set(t)}),n};e=function(r,e){return function(){var t=Pride.Util.slice(arguments);return Pride.Util.safeApply(e,t),_underscore2.default.each(i,function(e){e[r].apply(e,t)}),n}};this.run=e("run"),this.nextPage=e("nextPage"),this.prevPage=e("prevPage"),this.setMute=e("setMute",function(e){t=e}),this.getMute=function(){return t},this.setMute(t)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.Paginater=function(e){this.set=function(e){if(_underscore2.default.has(e,"total_pages"))throw"Can not set total_pages (it is a calculated value)";if(_underscore2.default.has(e,"index_limit"))throw"Can not set index_limit (it is a calculated value)";if(2<_underscore2.default.intersection(["start","end","count"],_underscore2.default.keys(e)).length)throw"Can not set start, end and count all at the same time";if(_underscore2.default.has(e,"page")&&(_underscore2.default.has(e,"start")||_underscore2.default.has(e,"end")))throw"Can not set page as well as the start and/or end";if(_underscore2.default.extend(t,_underscore2.default.omit(e,"end")),_underscore2.default.has(e,"page")&&(t.start=(t.count||0)*(t.page-1)),_underscore2.default.has(e,"end")){if(_underscore2.default.has(e,"count"))t.start=Math.max(0,e.end-(t.count-1));else{if(!(t.start<=e.end))throw"The start value can not be greater than the end value";t.count=e.end-t.start+1}t.end=e.end}else{e=t.start+t.count-1;t.end=e<t.start?void 0:e}if(_underscore2.default.isNumber(t.total_available)?0<t.total_available?t.index_limit=t.total_available-1:t.index_limit=void 0:t.index_limit=1/0,0<t.count&&t.start%t.count==0?(t.page=Math.floor(t.start/t.count)+1,_underscore2.default.isNumber(t.total_available)?(t.total_pages=Math.ceil(t.total_available/t.count),t.page_limit=t.total_pages):(t.total_pages=void 0,t.page_limit=1/0)):(t.page=void 0,t.total_pages=void 0,t.page_limit=void 0),!_underscore2.default.has(t,"start")||!_underscore2.default.has(t,"count"))throw"Not enough information given to create Paginater";return this},this.get=function(e){return t[e]};var t={};this.set(e)},Pride.Util.Paginater.getPossibleKeys=function(){return["start","count","end","page","index_limit","total_pages","total_available","page_limit"]},Pride.Util.Paginater.hasKey=function(e){return-1<Pride.Util.Paginater.getPossibleKeys().indexOf(e)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.Query=function(r){var i=new Pride.Util.Paginater({start:r.start,count:r.count}),n=Pride.Util.Paginater.getPossibleKeys();(r=_underscore2.default.omit(Pride.Util.deepClone(r),n)).request_id=r.request_id||0,this.get=function(e){return Pride.Util.Paginater.hasKey(e)?i.get(e):r[e]},this.set=function(e){var t=_underscore2.default.pick(e,n),e=_underscore2.default.omit(e,n);return _underscore2.default.isEmpty(e)||(i.set({total_available:void 0}),_underscore2.default.isNumber(e.request_id)||(r.request_id+=1)),i.set(t),_underscore2.default.extend(r,e),this},this.clone=function(){var e=Pride.Util.deepClone(r);return e.start=i.get("start"),e.count=i.get("count"),new Pride.Core.Query(e)},this.toSection=function(){return new Pride.Util.Section(this.get("start"),this.get("end"))},this.toLimitSection=function(){return new Pride.Util.Section(this.get("start"),this.get("index_limit"))},this.toJSON=function(){return{uid:this.get("uid"),request_id:this.get("request_id"),start:this.get("start"),count:this.get("count"),field_tree:this.get("field_tree"),facets:this.get("facets"),sort:this.get("sort"),settings:this.get("settings"),raw_query:this.get("raw_query")}}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.Record=function(i){var n=new Pride.Util.RequestBuffer({url:i.source,failure_message:Pride.Messenger.preset("failed_record_load",i.names[0]),edit_response:function(e){return i=s(e)}}),r=null,u={};this.placeHold=function(r,i,n,u){this.renderFull(function(e){var t;Pride.Util.request({url:[(_underscore2.default.each(e.fields,function(e){"holdings_url"===e.uid&&(t=e.value)}),t),r,i,n].join("/"),query:!0,failure:function(e){Pride.Messenger.sendMessage({summary:"Failed to place hold",class:"error"})},success:u,failure_message:"placeHold failed",success_message:"placeHold succeeded"})})},this.getHoldings=function(t){r?r.getData(t):i.complete?(r=new Pride.Core.Holdings(i)).getData(t):n.request({success:function(e){(r=new Pride.Core.Holdings(e)).getData(t)}})},this.getGetThis=function(t,r){u[t]?u[t].getData(r):i.complete?(u[t]=new Pride.Core.GetThis(t,i),u[t].getData(r)):n.request({success:function(e){u[t]=new Pride.Core.GetThis(t,e),u[t].getData(r)}})},this.renderPart=function(e){t(e)},this.renderPartThenCache=function(e){t(e),n.request()},this.renderFull=function(e){i.complete?t(e):n.request({success:e})},this.renderCSL=function(r){this.renderFull(function(e){var t;_underscore2.default.each(e.fields,function(e){"csl"===e.uid&&(t=e.value)}),r(t)})};var t=function(e){e(_underscore2.default.omit(i,"complete","source"),i.complete)},s=function(e){return e.fields=_underscore2.default.map(e.fields,function(e){return e.value_has_html||(e.value=Pride.Util.escape(e.value)),_underscore2.default.omit(e,"value_has_html")}),e.names_have_html||(e.names=_underscore2.default.map(e.names,function(e){return Pride.Util.escape(e)})),e.uid?e.status=200:e.status=404,Pride.PreferenceEngine.favorited(e)&&(e.favorited=!0,e.favorite_tags=Pride.PreferenceEngine.favoriteTags(e)),Pride.PreferenceEngine.selected(e)&&(e.selected=!0),_underscore2.default.omit(e,"names_have_html")};i=s(i)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.RequestBuffer=function(t){t=t||{};var r,i=new Pride.Util.FuncBuffer,n=!1,u=!1,s=!1;this.request=function(e){return i.add(e.success,"success").add(e.failure,"failure"),(n?a:o)(),this};var a=function(e){r=e||r,u?d("success"):s&&d("failure")},o=function(){n=!0,Pride.Util.request({url:Pride.Util.safeCall(t.url),attempts:Pride.Util.safeCall(t.attempts)||Pride.Settings.connection_attempts,failure_message:Pride.Util.safeCall(t.failure_message),failure:function(e){s=!0,Pride.Util.safeCall(t.before_failure,e),a(e),Pride.Util.safeCall(t.after_failure,e)},success:function(e){u=!0,Pride.Util.safeCall(t.before_success,e),_underscore2.default.isFunction(t.edit_response)&&(e=t.edit_response(e)),a(e),Pride.Util.safeCall(t.after_success,e)}})},d=function(e){i.call(e,r).clearAll()}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.SearchBase=function(e,r){this.datastore=e.datastore,this.query=e.query||this.datastore.baseQuery();var s=this,n=e.requestFunc||this.datastore.runQuery,u=e.starting_results||[],t=e.cache_size||Pride.Settings.cache_size[this.datastore.uid]||Pride.Settings.default_cache_size;this.log=function(){var e=Pride.Util.slice(arguments);e.unshift("Search ("+s.datastore.get("uid")+")"),Pride.Core.log.apply(window,e)},this.set=function(e){return s.query.set(e),Pride.Util.safeCall(s.setDataChanged),_underscore2.default.isEmpty(_underscore2.default.omit(e,Pride.Util.Paginater.getPossibleKeys()))||(u=[]),s},this.run=function(e){return Pride.Util.safeCall(s.resultsChanged),_underscore2.default.isUndefined(e)&&(e=t),i(d(s.query.toSection().expanded(e))),s},this.results=function(){return l(new Pride.Util.Section(s.query.get("start"),Math.min(s.query.get("end"),s.query.get("index_limit"))))};var i=function t(r){var i;s.log("REQUESTING",r),s.log("TOTAL AVAILABLE (pre-request)",s.query.get("total_available")),r&&s.query.toLimitSection().overlaps(r)?(s.log("Sending query..."),i=s.query.clone().set({start:r.start,count:r.calcLength()}),n({query:i,failure_message:Pride.Messenger.preset("failed_search_run",s.datastore.get("metadata").name),success:function(e){e.request.request_id==s.query.get("request_id")&&(o(e),a(e.response,i.get("start")),0!==(e=e.response.length)&&e<i.get("count")&&t(r.shifted(e,0)))}})):Pride.Util.safeCall(s.runDataChanged)},a=function(e,r){var i=!1;s.log("NEW RECORDS",e),_underscore2.default.each(e,function(e,t){t+=r;_underscore2.default.isUndefined(u[t])&&(u[t]=Pride.Util.safeCall(s.createItem,e),s.query.toSection().inSection(t)&&(i=!0))}),s.log("CACHE LENGTH",u.length),(i||_underscore2.default.isEmpty(e))&&Pride.Util.safeCall(s.resultsChanged)},o=function(e){s.datastore.update(e.datastore);var t=_underscore2.default.omit(e.new_request,"start","count");t.specialists=e.specialists,t.total_available=e.total_available,s.query.set(t),Pride.Util.safeCall(s.runDataChanged)},d=function(e){var t=l(e),r=_underscore2.default.indexOf(t,void 0);if(-1!=r){t=e.start+_underscore2.default.lastIndexOf(t,void 0);return r+=e.start,new Pride.Util.Section(r,t)}},l=function(e){for(var t=[],r=e.start;r<=e.end;r++)t.push(u[r]);return t},c=!1,f=[],h=[];this.clearAllObservers=function(){return _underscore2.default.each(f,function(e){e.clearAll()}),Pride.Util.safeCall(s.initialize_observables),s},this.getMute=function(){return c},this.setMute=function(e){return e!=c&&(c=e,Pride.Util.safeCall(s.muteChanged()),c||_underscore2.default.each(h,function(e){e.notify()})),s},this.createObservable=function(i,n,u){var e=new Pride.Util.FuncBuffer(function(){var t=this.add,r=this.call;f.push(this),u||h.push(this),this.add=function(e){return s.muted&&!u||e(n()),t(e,"observers"),this},this.notify=function(){var e;return s.muted&&!u||(e=n(),s.log("NOTIFY ("+i+")",e),r("observers",e)),this}});return s[i+"Changed"]=e.notify,r[i+"Observers"]=e,s},this.createObservable("mute",this.getMute,!0).createObservable("setData",function(){r.getData()}).createObservable("runData",function(){r.getData()}).createObservable("results",this.results),r.set=function(e){return s.set(e),r},r.run=function(e){return s.run(e),r},r.nextPage=function(e){var t=s.query.get("page");return _underscore2.default.isNumber(t)&&t<s.query.get("page_limit")&&(r.set({page:t+1}),r.run(e)),r},r.prevPage=function(e){var t=s.query.get("page");return _underscore2.default.isNumber(t)&&1<t&&(r.set({page:t-1}),r.run(e)),r}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.SearchSwitcher=function(r,e){var i=this,n=new Pride.Util.MultiSearch(null,!0,e);r.set({page:1}).setMute(!1),n.set({page:1}),this.uid=r.uid,this.run=function(e){return r.run(e),n.run(0),i},this.set=function(e){return r.set(e),n.set(_underscore2.default.omit(e,"page","facets")),i},this.nextPage=function(){return r.nextPage(),i},this.prevPage=function(){return r.prevPage(),i},this.switchTo=function(t){if(t!=r){if(r.setMute(!0).set({page:1}),n.searches.push(r),r=void 0,n.searches=_underscore2.default.reject(n.searches,function(e){if(e.uid==t)return r=e,!0}),!r)throw"Could not find a search with a UID of: "+t;i.uid=r.uid,r.setMute(!1)}return i}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.Section=function(e,t){this.start=Math.max(Math.min(e,t),0),this.end=Math.max(Math.max(e,t),0),this.inSection=function(e){return e>=this.start&&e<=this.end},this.overlaps=function(e){return this.inSection(e.start)||this.inSection(e.end)},this.calcLength=function(){return this.end-this.start+1},this.expanded=function(e){return this.shifted(-1*e,e)},this.shifted=function(e,t){return _underscore2.default.isNumber(t)||(t=e),new Pride.Util.Section(this.start+e,this.end+t)}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.deepClone=function(e){if(_underscore2.default.isFunction(e))return e;var t=!1;return _underscore2.default.isArray(e)?t="map":_underscore2.default.isObject(e)&&(t="mapObject"),t?_underscore2.default[t](e,function(e){return Pride.Util.deepClone(e)}):_underscore2.default.clone(e)},Pride.Util.escape=function(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.init=new Pride.Util.RequestBuffer({url:function(){return Pride.Settings.datastores_url},attempts:function(){return Pride.Settings.init_attempts},failure_message:function(){return Pride.Messenger.preset("failed_init")},edit_response:function(){},before_success:function(e){Pride.Settings.default_institution=e.default_institution,Pride.Settings.affiliation=e.affiliation,Pride.AllDatastores.array=_underscore2.default.map(e.response,function(e){return new Pride.Core.Datastore(e)})}}).request;_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.isDeepMatch=function(r,e){var t=_underscore2.default.isArray(r)&&_underscore2.default.isArray(e),i=_underscore2.default.isObject(r)&&_underscore2.default.isObject(e);return(!t||e.length==r.length)&&((!i||_underscore2.default.keys(e).length==_underscore2.default.keys(r).length)&&(t||i?_underscore2.default.every(e,function(e,t){return Pride.Util.isDeepMatch(r[t],e)}):r===e))},Pride.Core.log=function(e,t){var r;Pride.Settings.obnoxious&&((r=Pride.Util.slice(arguments,2)).unshift("[Pride: "+e+"] "+t),console.log.apply(console,r))},Pride.FieldTree.parseField=function(e,t){if(!t)return{};try{return Pride.Parser.parse(t,{defaultFieldName:e})}catch(e){return console.log(e),new Pride.FieldTree.Raw(t)}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.FieldTree=Pride.FieldTree||{},Pride.FieldTree.tokens=[":","AND","OR","+","-","(",")","*"," ","\n","\t","\r"],Pride.FieldTree.tokenize=function(e){for(var t=[],r=0,i=null;r<e.length;){var n,u=e.slice(r),s=_underscore2.default.find(Pride.FieldTree.tokens,function(e){return new RegExp("^\\"+e).exec(u)});s?(/\s/.exec(s)&&(i="whitespace"),r+=(i=s).length):(s=e.charAt(r),i="string",r++,(n=_underscore2.default.last(t))&&"string"==n.type&&(s=t.pop().content+s)),t.push({type:i,content:s})}return t};var _underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore),_reqwest=require("reqwest"),_reqwest2=_interopRequireDefault(_reqwest);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.request=function(t){if(Pride.Core.log("Request","Sending HTTP request..."),Pride.Core.log("Request","URL",t.url),Pride.Core.log("Request","CONTENT",JSON.stringify(t.query)),!t.url)throw"No URL given to Pride.Util.request()";var e="get";t.query&&(e="post"),_underscore2.default.isNumber(t.attempts)||(t.attempts=Pride.Settings.connection_attempts),--t.attempts,(0,_reqwest2.default)({url:t.url,data:JSON.stringify(t.query),type:"json",method:e,contentType:"application/json",withCredentials:!0,error:function(e){t.attempts<=0?(Pride.Core.log("Request","ERROR",e),Pride.Util.safeCall(t.failure,e),Pride.Messenger.sendMessage({summary:t.failure_message,class:"error"})):(Pride.Core.log("Request","Trying request again..."),window.setTimeout(function(){Pride.Util.request(t)},Pride.Settings.ms_between_attempts))},success:function(e){Pride.Core.log("Request","SUCCESS",e),Pride.Util.safeCall(t.success,e),Pride.Messenger.sendMessage({summary:t.success_message,class:"success"}),Pride.Messenger.sendMessageArray(e.messages)}})},Pride.requestRecord=function(e,t,r){void 0===r&&(r=function(e){});t={complete:!1,source:Pride.AllDatastores.get(e).get("url")+"/record/"+t,names:[void 0]},t=new Pride.Core.Record(t);return t.renderFull(r),t};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.safeCall=function(e){return _underscore2.default.isFunction(e)?e.apply(this,Pride.Util.slice(arguments,1)):e},Pride.Util.safeApply=function(e,t){return _underscore2.default.isFunction(e)?e.apply(this,t):e},Pride.Util.slice=function(e,t,r){return Array.prototype.slice.call(e,t,r)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.AllDatastores={array:[],get:function(t){return _underscore2.default.find(this.array,function(e){return e.get("uid")==t})},newSearch:function(t){var e=_underscore2.default.find(this.array,function(e){return e.get("uid")==t});return e?e.baseSearch():void 0},each:function(e){return _underscore2.default.each(this.array,e),this}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Messenger=new Pride.Util.FuncBuffer(function(){var t=this.call;this.addObserver=this.add,this.removeObserver=this.remove,this.clearObservers=this.clear,this.call=void 0,this.add=void 0,this.remove=void 0,this.clear=void 0,this.sendMessage=function(e){return e.summary&&(e.class=e.class||"info",e.details=e.details||"",t(e.class,e),Pride.Core.log("Messenger","MESSAGE SENT",e)),this},this.sendMessageArray=function(e){var t=this;return _underscore2.default.each(e,function(e){t.sendMessage(e)}),this},this.preset=function(e){}}),Pride.Parser=function(){function he(e,t,r,i){this.message=e,this.expected=t,this.found=r,this.location=i,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,he)}function e(){this.constructor=t}var t,r;return t=he,r=Error,e.prototype=r.prototype,t.prototype=new e,he.buildMessage=function(e,t){var r,u={literal:function(e){return'"'+n(e.text)+'"'},class:function(e){for(var t="",r=0;r<e.parts.length;r++)t+=e.parts[r]instanceof Array?s(e.parts[r][0])+"-"+s(e.parts[r][1]):s(e.parts[r]);return"["+(e.inverted?"^":"")+t+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function i(e){return e.charCodeAt(0).toString(16).toUpperCase()}function n(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}function s(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}return"Expected "+function(e){for(var t,r,i=new Array(e.length),n=0;n<e.length;n++)i[n]=(r=e[n],u[r.type](r));if(i.sort(),0<i.length){for(t=n=1;n<i.length;n++)i[n-1]!==i[n]&&(i[t]=i[n],t++);i.length=t}switch(i.length){case 1:return i[0];case 2:return i[0]+" or "+i[1];default:return i.slice(0,-1).join(", ")+", or "+i[i.length-1]}}(e)+" but "+((r=t)?'"'+n(r)+'"':"end of input")+" found."},{SyntaxError:he,parse:function(n,e){var u={},t={start:X},r=X,i=function(e){return e},s=function(e,t,r){return new Pride.FieldTree.FieldBoolean(t,e,r)},a=function(e,t){return t?[e,t]:e},o=function(e){return e},d=":",l=K(":",!1),c=function(e,t){return new Pride.FieldTree.Field(e,t)},f=function(e){return new Pride.FieldTree.Field(fe,e)},h=function(e){return e.join("")},_=function(e,t){return t?e.concat(t):e},g=function(e,t){return[new Pride.FieldTree.Literal(e+t.join(""))]},p=function(e){return[new Pride.FieldTree.Literal(e.join(""))]},v=function(e){return[new Pride.FieldTree.Literal('"'+e.join("")+'"')]},P=function(e){return e},m="AND",q=K("AND",!1),y="OR",C=K("OR",!1),R="NOT",b=K("NOT",!1),D="'",U=K("'",!1),F=/^[^']/,w=J(["'"],!0,!1),M='"',S=K('"',!1),x=/^[^"]/,T=J(['"'],!0,!1),A=/^[^ \t\r\n:'"()]/,O=J([" ","\t","\r","\n",":","'",'"',"(",")"],!0,!1),N=/^[^ \t\r\n():]/,E=J([" ","\t","\r","\n","(",")",":"],!0,!1),L=/^[^ \t\r\n'"():]/,j=J([" ","\t","\r","\n","'",'"',"(",")",":"],!0,!1),z=/^[ \t\r\n]/,B=J([" ","\t","\r","\n"],!1,!1),k=0,H=[{line:1,column:1}],I=0,Q=[],G=0;if("startRule"in(e=void 0!==e?e:{})){if(!(e.startRule in t))throw new Error("Can't start parsing from rule \""+e.startRule+'".');r=t[e.startRule]}function K(e,t){return{type:"literal",text:e,ignoreCase:t}}function J(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function V(e){var t,r=H[e];if(r)return r;for(t=e-1;!H[t];)t--;for(r={line:(r=H[t]).line,column:r.column};t<e;)10===n.charCodeAt(t)?(r.line++,r.column=1):r.column++,t++;return H[e]=r}function Y(e,t){var r=V(e),i=V(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:i.line,column:i.column}}}function $(e){k<I||(I<k&&(I=k,Q=[]),Q.push(e))}function W(e,t,r){return new he(he.buildMessage(e,t),e,t,r)}function X(){var e=k,t=function e(){var t,r,i,n;t=k;r=ee();t=r!==u?(n=ce(),n!==u?(i=re())!==u?ce()!==u?(n=e())!==u?r=s(r,i,n):(k=t,u):(k=t,u):(k=t,u):(k=t,u)):(k=t,u);t===u&&(t=Z());return t}();return e=t!==u&&function(){var e;(e=ce())===u&&(e=null);return e}()!==u?i(t):(k=e,u)}function Z(){var e,t,r=ee();return r===u&&(r=k,r=(e=ee())!==u&&(t=(t=function(){var e,t;e=k,e=ce()!==u?(t=Z(),t!==u?o(t):(k=e,u)):(k=e,u);return e}())===u?null:t)!==u?a(e,t):(k=r,u)),r}function ee(){var e,t,r=k,i=function(){var e,t,r;if(e=k,t=[],(r=oe())!==u)for(;r!==u;)t.push(r),r=oe();else t=u;t!==u&&(t=h(t));return e=t}();return(r=i!==u?(58===n.charCodeAt(k)?(e=d,k++):(e=u,0===G&&$(l)),e!==u&&(t=te())!==u?i=c(i,t):(k=r,u)):(k=r,u))===u&&(r=k,(i=te())!==u&&(i=f(i)),r=i),r}function te(){var e,t=k,r=function(){var e,t,r,i,n;t=e=k,G++,r=ie(),G--,t=r===u?void 0:(k=t,u);if(t!==u)if((r=le())!==u){if(i=[],(n=de())!==u)for(;n!==u;)i.push(n),n=de();else i=u;e=i!==u?t=g(r,i):(k=e,u)}else k=e,e=u;else k=e,e=u;if(e===u){if(t=e=k,G++,r=ie(),G--,(t=r===u?void 0:(k=t,u))!==u){if(r=[],(i=le())!==u)for(;i!==u;)r.push(i),i=le();else r=u;e=r!==u?t=p(r):(k=e,u)}else k=e,e=u;if(e===u){if(e=k,(t=ne())!==u){for(r=[],i=ue();i!==u;)r.push(i),i=ue();e=r!==u?(i=ne())!==u?t=v(r):(k=e,u):(k=e,u)}else k=e,e=u;if(e===u)if(e=k,(t=se())!==u){for(r=[],i=ae();i!==u;)r.push(i),i=ae();e=r!==u?(i=se())!==u?t=v(r):(k=e,u):(k=e,u)}else k=e,e=u}}return e}();return t=r!==u&&(e=(e=function(){var e,t;e=k,e=ce()!==u?(t=te(),t!==u?o(t):(k=e,u)):(k=e,u);return e}())===u?null:e)!==u?_(r,e):(k=t,u)}function re(){var e=k,t=ie();return t!==u&&(t=P(t)),e=t}function ie(){var e;return n.substr(k,3)===m?(e=m,k+=3):(e=u,0===G&&$(q)),e===u&&(n.substr(k,2)===y?(e=y,k+=2):(e=u,0===G&&$(C)),e===u&&(n.substr(k,3)===R?(e=R,k+=3):(e=u,0===G&&$(b)))),e}function ne(){var e;return 39===n.charCodeAt(k)?(e=D,k++):(e=u,0===G&&$(U)),e}function ue(){var e;return F.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(w)),e}function se(){var e;return 34===n.charCodeAt(k)?(e=M,k++):(e=u,0===G&&$(S)),e}function ae(){var e;return x.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(T)),e}function oe(){var e;return A.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(O)),e}function de(){var e;return N.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(E)),e}function le(){var e;return L.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(j)),e}function ce(){var e,t=[];if(z.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(B)),e!==u)for(;e!==u;)t.push(e),z.test(n.charAt(k))?(e=n.charAt(k),k++):(e=u,0===G&&$(B));else t=u;return t}var fe=e.defaultFieldName||"all_fields";if((r=r())!==u&&k===n.length)return r;throw r!==u&&k<n.length&&$({type:"end"}),W(Q,I<n.length?n.charAt(I):null,I<n.length?Y(I,I+1):Y(I,I))}}}(),Pride.PreferenceEngine={favoritedRecords:null,favoritedRecordsTags:null,selectedRecords:null,engine:null,favorited:function(e){return!!this.engine&&(this.favoritedRecords[e.datastore]||{})[e.uid]},selected:function(e){return!!this.engine&&(this.selectedRecords[e.datastore]||{})[e.uid]},favoriteTags:function(e){return this.engine&&(this.favoritedRecordsTags[e.datastore]||{})[e.uid]||[]},registerEngine:function(e){return(this.engine=e)&&(this.updateSelectedRecords(this.engine.listRecords()),this.updateFavoritedRecords(this.engine.favoritesList.last),this.engine.addFavoritesListObserver((t=this,function(e){t.updateFavoritedRecords(e)})),this.engine.addObserver((r=this,function(e){r.updateSelectedRecords(e)}))),this;var t,r},blankList:function(){return{mirlyn:{},articlesplus:{},databases:{},journals:{},website:{}}},updateFavoritedRecords:function(e){return this.favoritedRecords=this.favoritedRecords||this.blankList(),this.favoritedRecordsTags=this.favoritedRecordsTags||this.blankList(),!e||e.length<1||!e.forEach?(this.favoritedRecords=this.blankList(),this.favoritedRecordsTags=this.blankList()):e.forEach(function(e){var t,r,i;if(0<=(t=e.tags.indexOf("mirlyn-favorite")))r=e.id[0].split("/")[4],i="mirlyn";else if(0<=(t=e.tags.indexOf("articles-favorite")))r=e.id[0].split("/")[5],i="articlesplus";else if(0<=(t=e.tags.indexOf("databases-favorite")))r=e.id[0].split("/")[4],i="databases";else if(0<=(t=e.tags.indexOf("journals-favorite")))r=e.id[0].split("/")[4],i="journals";else{if(!(0<=(t=e.tags.indexOf("website-favorite"))))return this;r=e.id[0],i="website"}e=e.tags.slice(0,t).concat(e.tags.slice(t+1,e.tags.length)),this.favoritedRecords[i][r]=!0,this.favoritedRecordsTags[i][r]=e},this),this},updateSelectedRecords:function(e){if(this.selectedRecords=this.selectedRecords||this.blankList(),e.forEach)return e.forEach(function(e){this.selectedRecords[e.datastore]=this.selectedRecords[e.datastore]||{},this.selectedRecords[e.datastore][e.uid]=!0},this),this;for(var t in e)e.hasOwnProperty(t)&&(this.selectedRecords[t]={},e[t].forEach(function(t){return function(e){this.selectedRecords[t][e.uid]=!0}}(t),this));return this}};