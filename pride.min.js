"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var Pride=exports.Pride={};Pride.Util={},Pride.Core={},Pride.Settings={default_cache_size:20,cache_size:{},datastores_url:"",connection_attempts:3,init_attempts:3,ms_between_attempts:1500,message_formats:{failed_record_load:"Failed to load $1",failed_search_run:"Failed to search $1",failed_init:"Failed to initialize Pride"},obnoxious:!1};var _underscore=require("underscore");Pride.Core.Datastore=function(e){e=Pride.Util.deepClone(e),this.baseQuery=function(){return new Pride.Core.Query({uid:e.uid,sort:e.default_sort,start:0,count:0,settings:{},field_tree:t(),facets:_underscore._.reduce(e.facets,function(e,t){return t.required&&!t.fixed&&(e[t.uid]=t.default_value),e},{})})},this.baseSearch=function(){return new Pride.Core.DatastoreSearch({datastore:this})},this.runQuery=function(t){return t.url=e.url,Pride.Util.request(t),this},this.get=function(t){return e[t]},this.update=function(t){_underscore._.extend(e,t)};var t=function(t){t=t||new Pride.FieldTree.FieldBoolean("AND");var r=_underscore._.reduce(e.fields,function(e,t){return!t.required&&!t.fixed||e.contains({type:"field",value:t.uid})?e:(missing_field=new Pride.FieldTree.Field(t.uid,new Pride.FieldTree.Literal(t.default_value)),_underscore._.isMatch(e,{type:"field_boolean",value:"AND"})?e.addChild(missing_field):new Pride.FieldTree.FieldBoolean("AND",e,missing_field))},t);return r.matches({type:"field_boolean",children:[]})?{}:r}};var _underscore=require("underscore");Pride.Core.DatastoreSearch=function(e){var t=this,r=new Pride.Core.SearchBase(e,this);r.createItem=function(e){return new Pride.Core.Record(e)};var i=[],n=[];this.getFacets=function(){return i},this.uid=r.datastore.get("uid"),this.getData=function(){return{uid:t.uid,metadata:Pride.Util.deepClone(r.datastore.get("metadata")),sorts:Pride.Util.deepClone(r.datastore.get("sorts")),selected_sort:r.query.get("sort"),facets:Pride.Util.deepClone(r.query.get("facets")),fields:Pride.Util.deepClone(r.datastore.get("fields")),field_tree:Pride.Util.deepClone(r.query.get("field_tree")),settings:Pride.Util.deepClone(r.query.get("settings")),page:r.query.get("page"),count:r.query.get("count"),total_available:r.query.get("total_available"),total_pages:r.query.get("total_pages"),page_limit:r.query.get("page_limit"),specialists:Pride.Util.deepClone(r.query.get("specialists"))}},this.getResults=r.results,r.initialize_observables=function(){t.runDataObservers.add(function(){var e=r.datastore.get("facets");Pride.Util.isDeepMatch(n,e)||(_underscore._.each(i,function(e){e.clearAllObservers()}),i=_underscore._.map(e,function(e){return new Pride.Core.FacetSearch({data:_underscore._.omit(e,"values"),results:e.values})}),n=e,t.facetsObservers.notify())})},this.getMute=r.getMute,this.setMute=function(e){return _underscore._.each(i,function(t){t.setMute(e)}),r.setMute(e),t},r.createObservable("facets",this.getFacets).initialize_observables()};var _underscore=require("underscore");Pride.Core.FacetSearch=function(e){var t=e.data,r=e.results;this.uid=t.uid,this.getData=function(){return t},this.getResults=function(){return r};var i=!1;this.getMute=function(){return i},this.setMute=function(e){return i=e,self};var n=[];this.clearAllObservers=function(){return _underscore._.each(n,function(e){e.clearAll()}),self};var s=function(e,r){return new Pride.Util.FuncBuffer(function(){var i=this.add,s=this.call;n.push(this),this.add=function(e){return self.muted||e(r()),i(e,"observers"),this},this.notify=function(){return self.muted||(t=r(),self.log("NOTIFY ("+e+")",t),s("observers",t)),this}})};this.resultsObservers=s("results",this.getResults),this.setDataObservers=s("setData",this.getData),this.runDataObservers=s("runData",this.getData)};var _underscore=require("underscore");Pride.FieldTree={},Pride.Core.nodeFactory=function(e,t,r){return function(i){this.children=Pride.Util.slice(arguments,1),1===this.children.length&&Array.isArray(this.children[0])&&(this.children=this.children[0]),this.type=e,this.value=i.trim(),this.child_types=t||[],this.validIfEmpty=!0,this.addChild=function(e){if(!_underscore._.find(this.child_types,function(t){return e.type===t}))throw"Not a valid child for a "+this.type;return this.children.push(e),this},this.contains=function(e){return this.matches(e)?this:!_underscore._.isEmpty(this.children)&&_underscore._.find(this.children,function(t){return t.contains(e)})},this.matches=function(e){var t=this,r=e.children||[];return _underscore._.every(_underscore._.omit(e,"children"),function(e,r){return t[r]==e})&&_underscore._.every(r,function(e){return _underscore._.any(children,function(t){return e.matches(t)})})},this.serialize=function(){return i},this.serializedChildren=function(){return _underscore._.chain(this.children).map(function(e){return e.serialize()}).compact().value()},this.toJSON=function(){return _underscore._.mapObject(_underscore._.pick(this,"value","children","type"),function(e,t){return"children"==t?_underscore._.map(e,function(e){return e.toJSON()}):e})},_underscore._.isFunction(r)&&r.call(this)}},Pride.Core.boolNodeFactory=function(e,t){return Pride.Core.nodeFactory(e,t,function(){if(!_underscore._.contains(["AND","OR","NOT"],this.value))throw"Not a valid boolean value";this.serialize=function(){return this.serializedChildren().join(" "+this.value+" ")},this.serializedChildren=function(){var e=this;return _underscore._.chain(e.children).map(function(t){return t.type==e.type||"literal"==t.type&&t.value.match(/\s/)?"("+t.serialize()+")":t.serialize()}).compact().value()}})};var top_level_nodes=["field_boolean","field"],inside_field_nodes=["value_boolean","literal","tag","special"];Pride.FieldTree.FieldBoolean=Pride.Core.boolNodeFactory("field_boolean",top_level_nodes),Pride.FieldTree.ValueBoolean=Pride.Core.boolNodeFactory("value_boolean",inside_field_nodes),Pride.FieldTree.Field=Pride.Core.nodeFactory("field",inside_field_nodes,function(){this.serialize=function(){return this.value+": ("+this.serializedChildren().join(" ")+")"}}),Pride.FieldTree.Tag=Pride.Core.nodeFactory("tag",inside_field_nodes,function(){this.serialize=function(){var e=this.serializedChildren();return 0===e.length?"":this.value+"("+e.join(" ")+")"}}),Pride.FieldTree.Literal=Pride.Core.nodeFactory("literal"),Pride.FieldTree.Special=Pride.Core.nodeFactory("special");var _underscore=require("underscore");Pride.Util.FuncBuffer=function(e){var t={},r=this,i=function(e){return _underscore._.has(t,e)||(t[e]=[]),t[e]};this.add=function(e,t){return i(t).push(e),r},this.remove=function(e,n){return t[n]=_underscore._.reject(i(n),function(t){return e==t}),r},this.clear=function(e){return delete t[e],r},this.clearAll=function(){return t={},r},this.call=function(e){return r.apply(e,Pride.Util.slice(arguments,1)),r},this.apply=function(e,t){return _underscore._.each(i(e),function(e){Pride.Util.safeApply(e,t)}),r},_underscore._.isFunction(e)&&e.call(this)};var _underscore=require("underscore");Pride.Core.GetThis=function(e,t){this.barcode=e,this.data=t;var r=new Pride.Util.RequestBuffer({url:function(e){var t;return _underscore._.each(e.fields,function(e){"get_this_url"===e.uid&&(t=e.value)}),t}(t)+"/"+this.barcode,failure_message:Pride.Messenger.preset("failed_get_this_load",t.names[0]),edit_response:function(e){return t=i(e)}}),i=function(e){return e};this.getData=function(e){r.request({success:e})}};var _underscore=require("underscore");Pride.Core.Holdings=function(e){this.data=e;var t=function(e){var t;return _underscore._.each(e.fields,function(e){"resource_access"===e.uid&&(t=e.value)}),t},r=new Pride.Util.RequestBuffer({url:function(e){var t;return _underscore._.each(e.fields,function(e){"holdings_url"===e.uid&&(t=e.value)}),t}(e),failure_message:Pride.Messenger.preset("failed_holdings_load",e.names[0]),edit_response:function(t){return e=i(t)}}),i=function(r){return[t(e)].concat(r)};this.getData=function(e){r.request({success:e})}};var _underscore=require("underscore");Pride.Util.MultiSearch=function(e,t,r){var i={},n=this;this.searches=r,this.uid=e,this.set=function(e){return _underscore._.extend(i,e),_underscore._.each(r,function(t){t.set(e)}),n};var s=function(e,t){return function(){var i=Pride.Util.slice(arguments);return Pride.Util.safeApply(t,i),_underscore._.each(r,function(t){t[e].apply(t,i)}),n}};this.run=s("run"),this.nextPage=s("nextPage"),this.prevPage=s("prevPage"),this.setMute=s("setMute",function(e){t=e}),this.getMute=function(){return t},this.setMute(t)};var _underscore=require("underscore");Pride.Util.Paginater=function(e){this.set=function(e){if(_underscore._.has(e,"total_pages"))throw"Can not set total_pages (it is a calculated value)";if(_underscore._.has(e,"index_limit"))throw"Can not set index_limit (it is a calculated value)";if(_underscore._.intersection(["start","end","count"],_underscore._.keys(e)).length>2)throw"Can not set start, end and count all at the same time";if(_underscore._.has(e,"page")&&(_underscore._.has(e,"start")||_underscore._.has(e,"end")))throw"Can not set page as well as the start and/or end";if(_underscore._.extend(t,_underscore._.omit(e,"end")),_underscore._.has(e,"page")&&(t.start=(t.count||0)*(t.page-1)),_underscore._.has(e,"end")){if(_underscore._.has(e,"count"))t.start=Math.max(0,e.end-(t.count-1));else{if(!(t.start<=e.end))throw"The start value can not be greater than the end value";t.count=e.end-t.start+1}t.end=e.end}else{var r=t.start+t.count-1;t.end=r<t.start?void 0:r}if(_underscore._.isNumber(t.total_available)?t.total_available>0?t.index_limit=t.total_available-1:t.index_limit=void 0:t.index_limit=1/0,t.count>0&&t.start%t.count==0?(t.page=Math.floor(t.start/t.count)+1,_underscore._.isNumber(t.total_available)?(t.total_pages=Math.ceil(t.total_available/t.count),t.page_limit=t.total_pages):(t.total_pages=void 0,t.page_limit=1/0)):(t.page=void 0,t.total_pages=void 0,t.page_limit=void 0),!_underscore._.has(t,"start")||!_underscore._.has(t,"count"))throw"Not enough information given to create Paginater";return this},this.get=function(e){return t[e]};var t={};this.set(e)},Pride.Util.Paginater.getPossibleKeys=function(){return["start","count","end","page","index_limit","total_pages","total_available","page_limit"]},Pride.Util.Paginater.hasKey=function(e){return Pride.Util.Paginater.getPossibleKeys().indexOf(e)>-1};var _underscore=require("underscore");Pride.Core.Query=function(e){var t=new Pride.Util.Paginater({start:e.start,count:e.count}),r=Pride.Util.Paginater.getPossibleKeys();e=_underscore._.omit(Pride.Util.deepClone(e),r),e.request_id=e.request_id||0,this.get=function(r){return Pride.Util.Paginater.hasKey(r)?t.get(r):e[r]},this.set=function(i){var n=_underscore._.pick(i,r),s=_underscore._.omit(i,r);return _underscore._.isEmpty(s)||(t.set({total_available:void 0}),_underscore._.isNumber(s.request_id)||(e.request_id+=1)),t.set(n),_underscore._.extend(e,s),this},this.clone=function(){var r=Pride.Util.deepClone(e);return r.start=t.get("start"),r.count=t.get("count"),new Pride.Core.Query(r)},this.toSection=function(){return new Pride.Util.Section(this.get("start"),this.get("end"))},this.toLimitSection=function(){return new Pride.Util.Section(this.get("start"),this.get("index_limit"))},this.toJSON=function(){return{uid:this.get("uid"),request_id:this.get("request_id"),start:this.get("start"),count:this.get("count"),field_tree:this.get("field_tree"),facets:this.get("facets"),sort:this.get("sort"),settings:this.get("settings")}}};var _underscore=require("underscore");Pride.Core.Record=function(e){var t=new Pride.Util.RequestBuffer({url:e.source,failure_message:Pride.Messenger.preset("failed_record_load",e.names[0]),edit_response:function(t){return e=s(t)}}),r=null,i={};this.placeHold=function(e,t,r,i){this.renderFull(function(n){Pride.Util.request({url:[function(){var e;return _underscore._.each(n.fields,function(t){"holdings_url"===t.uid&&(e=t.value)}),e}(),e,t,r].join("/"),query:!0,failure:function(e){Pride.Messenger.sendMessage({summary:"Failed to place hold",class:"error"})},success:i,failure_message:"placeHold failed",success_message:"placeHold succeeded"})})},this.getHoldings=function(i){r?r.getData(i):e.complete?(r=new Pride.Core.Holdings(e),r.getData(i)):t.request({success:function(e){r=new Pride.Core.Holdings(e),r.getData(i)}})},this.getGetThis=function(r,n){i[r]?i[r].getData(n):e.complete?(i[r]=new Pride.Core.GetThis(r,e),i[r].getData(n)):t.request({success:function(e){i[r]=new Pride.Core.GetThis(r,e),i[r].getData(n)}})},this.renderPart=function(e){n(e)},this.renderPartThenCache=function(e){n(e),t.request()},this.renderFull=function(r){e.complete?n(r):t.request({success:r})},this.renderCSL=function(e){this.renderFull(function(t){var r;_underscore._.each(t.fields,function(e){"csl"===e.uid&&(r=e.value)}),e(r)})};var n=function(t){t(_underscore._.omit(e,"complete","source"),e.complete)},s=function(e){return e.fields=_underscore._.map(e.fields,function(e){return e.value_has_html||(e.value=Pride.Util.escape(e.value)),_underscore._.omit(e,"value_has_html")}),e.names_have_html||(e.names=_underscore._.map(e.names,function(e){return Pride.Util.escape(e)})),e.uid?e.status=200:e.status=404,Pride.PreferenceEngine.favorited(e)&&(e.favorited=!0,e.favorite_tags=Pride.PreferenceEngine.favoriteTags(e)),Pride.PreferenceEngine.selected(e)&&(e.selected=!0),_underscore._.omit(e,"names_have_html")};e=s(e)};var _underscore=require("underscore");Pride.Util.RequestBuffer=function(e){e=e||{};var t,r=new Pride.Util.FuncBuffer,i=!1,n=!1,s=!1;this.request=function(e){return r.add(e.success,"success").add(e.failure,"failure"),i?u():a(),this};var u=function(e){t=e||t,n?o("success"):s&&o("failure")},a=function(){i=!0,Pride.Util.request({url:Pride.Util.safeCall(e.url),attempts:Pride.Util.safeCall(e.attempts)||Pride.Settings.connection_attempts,failure_message:Pride.Util.safeCall(e.failure_message),failure:function(t){s=!0,Pride.Util.safeCall(e.before_failure,t),u(t),Pride.Util.safeCall(e.after_failure,t)},success:function(t){n=!0,Pride.Util.safeCall(e.before_success,t),_underscore._.isFunction(e.edit_response)&&(t=e.edit_response(t)),u(t),Pride.Util.safeCall(e.after_success,t)}})},o=function(e){r.call(e,t).clearAll()}};var _underscore=require("underscore");Pride.Core.SearchBase=function(e,t){this.datastore=e.datastore,this.query=e.query||this.datastore.baseQuery();var r=this,i=e.requestFunc||this.datastore.runQuery,n=e.starting_results||[],s=e.cache_size||Pride.Settings.cache_size[this.datastore.uid]||Pride.Settings.default_cache_size;this.log=function(){var e=Pride.Util.slice(arguments);e.unshift("Search ("+r.datastore.get("uid")+")"),Pride.Core.log.apply(window,e)},this.set=function(e){return r.query.set(e),Pride.Util.safeCall(r.setDataChanged),_underscore._.isEmpty(_underscore._.omit(e,Pride.Util.Paginater.getPossibleKeys()))||(n=[]),r},this.run=function(e){return Pride.Util.safeCall(r.resultsChanged),_underscore._.isUndefined(e)&&(e=s),u(c(r.query.toSection().expanded(e))),r},this.results=function(){return d(new Pride.Util.Section(r.query.get("start"),Math.min(r.query.get("end"),r.query.get("index_limit"))))};var u=function e(t){if(r.log("REQUESTING",t),r.log("TOTAL AVAILABLE (pre-request)",r.query.get("total_available")),t&&r.query.toLimitSection().overlaps(t)){r.log("Sending query...");var n=r.query.clone().set({start:t.start,count:t.calcLength()});i({query:n,failure_message:Pride.Messenger.preset("failed_search_run",r.datastore.get("metadata").name),success:function(i){if(i.request.request_id==r.query.get("request_id")){o(i),a(i.response,n.get("start"));var s=i.response.length;0!==s&&s<n.get("count")&&e(t.shifted(s,0))}}})}else Pride.Util.safeCall(r.runDataChanged)},a=function(e,t){var i=!1;r.log("NEW RECORDS",e),_underscore._.each(e,function(e,s){var u=s+t;_underscore._.isUndefined(n[u])&&(n[u]=Pride.Util.safeCall(r.createItem,e),r.query.toSection().inSection(u)&&(i=!0))}),r.log("CACHE LENGTH",n.length),(i||_underscore._.isEmpty(e))&&Pride.Util.safeCall(r.resultsChanged)},o=function(e){r.datastore.update(e.datastore);var t=_underscore._.omit(e.new_request,"start","count");t.specialists=e.specialists,t.total_available=e.total_available,r.query.set(t),Pride.Util.safeCall(r.runDataChanged)},c=function(e){var t=d(e),r=_underscore._.indexOf(t,void 0);if(-1!=r){var i=e.start+_underscore._.lastIndexOf(t,void 0);return r+=e.start,new Pride.Util.Section(r,i)}},d=function(e){for(var t=[],r=e.start;r<=e.end;r++)t.push(n[r]);return t},l=!1,f=[],h=[];this.clearAllObservers=function(){return _underscore._.each(f,function(e){e.clearAll()}),Pride.Util.safeCall(r.initialize_observables),r},this.getMute=function(){return l},this.setMute=function(e){return e!=l&&(l=e,Pride.Util.safeCall(r.muteChanged()),l||_underscore._.each(h,function(e){e.notify()})),r},this.createObservable=function(e,i,n){var s=new Pride.Util.FuncBuffer(function(){var t=this.add,s=this.call;f.push(this),n||h.push(this),this.add=function(e){return r.muted&&!n||e(i()),t(e,"observers"),this},this.notify=function(){if(!r.muted||n){var t=i();r.log("NOTIFY ("+e+")",t),s("observers",t)}return this}});return r[e+"Changed"]=s.notify,t[e+"Observers"]=s,r},this.createObservable("mute",this.getMute,!0).createObservable("setData",function(){t.getData()}).createObservable("runData",function(){t.getData()}).createObservable("results",this.results),t.set=function(e){return r.set(e),t},t.run=function(e){return r.run(e),t},t.nextPage=function(e){var i=r.query.get("page");return _underscore._.isNumber(i)&&i<r.query.get("page_limit")&&(t.set({page:i+1}),t.run(e)),t},t.prevPage=function(e){var i=r.query.get("page");return _underscore._.isNumber(i)&&i>1&&(t.set({page:i-1}),t.run(e)),t}};var _underscore=require("underscore");Pride.Util.SearchSwitcher=function(e,t){var r=this,i=new Pride.Util.MultiSearch(null,!0,t);e.set({page:1}).setMute(!1),i.set({page:1}),this.uid=e.uid,this.run=function(t){return e.run(t),i.run(0),r},this.set=function(t){return e.set(t),i.set(_underscore._.omit(t,"page","facets")),r},this.nextPage=function(){return e.nextPage(),r},this.prevPage=function(){return e.prevPage(),r},this.switchTo=function(t){if(t!=e){if(e.setMute(!0).set({page:1}),i.searches.push(e),e=void 0,i.searches=_underscore._.reject(i.searches,function(r){if(r.uid==t)return e=r,!0}),!e)throw"Could not find a search with a UID of: "+t;r.uid=e.uid,e.setMute(!1)}return r}};var _underscore=require("underscore");Pride.Util.Section=function(e,t){this.start=Math.max(Math.min(e,t),0),this.end=Math.max(Math.max(e,t),0),this.inSection=function(e){return e>=this.start&&e<=this.end},this.overlaps=function(e){return this.inSection(e.start)||this.inSection(e.end)},this.calcLength=function(){return this.end-this.start+1},this.expanded=function(e){return this.shifted(-1*e,e)},this.shifted=function(e,t){return _underscore._.isNumber(t)||(t=e),new Pride.Util.Section(this.start+e,this.end+t)}};var _underscore=require("underscore");Pride.Util.deepClone=function(e){if(_underscore._.isFunction(e))return e;var t=!1;return _underscore._.isArray(e)?t="map":_underscore._.isObject(e)&&(t="mapObject"),t?_underscore._[t](e,function(e){return Pride.Util.deepClone(e)}):_underscore._.clone(e)},Pride.Util.escape=function(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML};var _underscore=require("underscore");Pride.init=new Pride.Util.RequestBuffer({url:function(){return Pride.Settings.datastores_url},attempts:function(){return Pride.Settings.init_attempts},failure_message:function(){return Pride.Messenger.preset("failed_init")},edit_response:function(){},before_success:function(e){Pride.Settings.default_institution=e.default_institution,Pride.Settings.affiliation=e.affiliation,Pride.AllDatastores.array=_underscore._.map(e.response,function(e){return new Pride.Core.Datastore(e)})}}).request;var _underscore=require("underscore");Pride.Util.isDeepMatch=function(e,t){var r=_underscore._.isArray(e)&&_underscore._.isArray(t),i=_underscore._.isObject(e)&&_underscore._.isObject(t);return(!r||t.length==e.length)&&((!i||_underscore._.keys(t).length==_underscore._.keys(e).length)&&(r||i?_underscore._.every(t,function(t,r){return Pride.Util.isDeepMatch(e[r],t)}):e===t))},Pride.Core.log=function(e,t){if(Pride.Settings.obnoxious){var r=Pride.Util.slice(arguments,2);r.unshift("[Pride: "+e+"] "+t),console.log.apply(console,r)}},Pride.FieldTree.parseField=function(e,t){if(!t)return{};try{return Pride.Parser.parse(t,{defaultFieldName:e})}catch(r){return console.log(r),new Pride.FieldTree.Field(e,new Pride.FieldTree.Literal(t))}};var _underscore=require("underscore");Pride.FieldTree=Pride.FieldTree||{},Pride.FieldTree.tokens=[":","AND","OR","+","-","(",")","*"," ","\n","\t","\r"],Pride.FieldTree.tokenize=function(e){for(var t=[],r=0,i=null;r<e.length;){var n=e.slice(r),s=_underscore._.find(Pride.FieldTree.tokens,function(e){return new RegExp("^\\"+e).exec(n)});if(s)/\s/.exec(s)&&(i="whitespace"),i=s,r+=s.length;else{s=e.charAt(r),i="string",r++;var u=_underscore._.last(t);u&&"string"==u.type&&(s=t.pop().content+s)}t.push({type:i,content:s})}return t};var _underscore=require("underscore"),_reqwest=require("reqwest"),_reqwest2=_interopRequireDefault(_reqwest);Pride.Util.request=function(e){if(Pride.Core.log("Request","Sending HTTP request..."),Pride.Core.log("Request","URL",e.url),Pride.Core.log("Request","CONTENT",JSON.stringify(e.query)),!e.url)throw"No URL given to Pride.Util.request()";var t="get";e.query&&(t="post"),_underscore._.isNumber(e.attempts)||(e.attempts=Pride.Settings.connection_attempts),e.attempts-=1,(0,_reqwest2.default)({url:e.url,data:JSON.stringify(e.query),type:"json",method:t,contentType:"application/json",withCredentials:!0,error:function(t){e.attempts<=0?(Pride.Core.log("Request","ERROR",t),Pride.Util.safeCall(e.failure,t),Pride.Messenger.sendMessage({summary:e.failure_message,class:"error"})):(Pride.Core.log("Request","Trying request again..."),window.setTimeout(function(){Pride.Util.request(e)},Pride.Settings.ms_between_attempts))},success:function(t){Pride.Core.log("Request","SUCCESS",t),Pride.Util.safeCall(e.success,t),Pride.Messenger.sendMessage({summary:e.success_message,class:"success"}),Pride.Messenger.sendMessageArray(t.messages)}})},Pride.requestRecord=function(e,t,r){void 0===r&&(r=function(e){});var i={complete:!1,source:Pride.AllDatastores.get(e).get("url")+"/record/"+t,names:[void 0]},n=new Pride.Core.Record(i);return n.renderFull(r),n};var _underscore=require("underscore");Pride.Util.safeCall=function(e){return _underscore._.isFunction(e)?e.apply(this,Pride.Util.slice(arguments,1)):e},Pride.Util.safeApply=function(e,t){return _underscore._.isFunction(e)?e.apply(this,t):e},Pride.Util.slice=function(e,t,r){return Array.prototype.slice.call(e,t,r)};var _underscore=require("underscore");Pride.AllDatastores={array:[],get:function(e){return _underscore._.find(this.array,function(t){return t.get("uid")==e})},newSearch:function(e){var t=_underscore._.find(this.array,function(t){return t.get("uid")==e});return t?t.baseSearch():void 0},each:function(e){return _underscore._.each(this.array,e),this}},Pride.Messenger=new Pride.Util.FuncBuffer(function(){this.call;this.addObserver=this.add,this.removeObserver=this.remove,this.clearObservers=this.clear,this.call=void 0,this.add=void 0,this.remove=void 0,this.clear=void 0,this.sendMessage=function(e){},this.sendMessageArray=function(e){},this.preset=function(e){}}),Pride.Parser=function(){function e(t,r,i,n){this.message=t,this.expected=r,this.found=i,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function t(t,r){function i(e,t){return{type:"literal",text:e,ignoreCase:t}}function n(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function s(e){return{type:"other",description:e}}function u(e){var r,i=Pe[e];if(i)return i;for(r=e-1;!Pe[r];)r--;for(i=Pe[r],i={line:i.line,column:i.column};r<e;)10===t.charCodeAt(r)?(i.line++,i.column=1):i.column++,r++;return Pe[e]=i,i}function a(e,t){var r=u(e),i=u(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:i.line,column:i.column}}}function o(e){pe<me||(pe>me&&(me=pe,ye=[]),ye.push(e))}function c(t,r,i){return new e(e.buildMessage(t,r),t,r,i)}function d(){var e,t,r;return e=pe,t=l(),t!==A?(r=S(),r!==A?(ve=e,t=D(t),e=t):(pe=e,e=A)):(pe=e,e=A),e}function l(){var e,t,r,i,n,s;return e=pe,t=_(),t!==A?(r=x(),r!==A?(i=m(),i!==A?(n=x(),n!==A?(s=l(),s!==A?(ve=e,t=N(t,i,s),e=t):(pe=e,e=A)):(pe=e,e=A)):(pe=e,e=A)):(pe=e,e=A)):(pe=e,e=A),e===A&&(e=f()),e}function f(){var e,t,r;return e=_(),e===A&&(e=pe,t=_(),t!==A?(r=h(),r===A&&(r=null),r!==A?(ve=e,t=E(t,r),e=t):(pe=e,e=A)):(pe=e,e=A)),e}function h(){var e,t,r;return e=pe,t=x(),t!==A?(r=f(),r!==A?(ve=e,t=L(r),e=t):(pe=e,e=A)):(pe=e,e=A),e}function _(){var e,r,i,n;return e=pe,r=g(),r!==A?(58===t.charCodeAt(pe)?(i=j,pe++):(i=A,0===be&&o(z)),i!==A?(n=p(),n!==A?(ve=e,r=B(r,n),e=r):(pe=e,e=A)):(pe=e,e=A)):(pe=e,e=A),e===A&&(e=pe,r=p(),r!==A&&(ve=e,r=k(r)),e=r),e}function g(){var e,t,r;if(e=pe,t=[],(r=F())!==A)for(;r!==A;)t.push(r),r=F();else t=A;return t!==A&&(ve=e,t=H(t)),e=t}function p(){var e,t,r;return e=pe,t=P(),t!==A?(r=v(),r===A&&(r=null),r!==A?(ve=e,t=I(t,r),e=t):(pe=e,e=A)):(pe=e,e=A),e}function v(){var e,t,r;return e=pe,t=x(),t!==A?(r=p(),r!==A?(ve=e,t=L(r),e=t):(pe=e,e=A)):(pe=e,e=A),e}function P(){var e,t,r,i,n;if(e=pe,t=pe,be++,r=y(),be--,r===A?t=void 0:(pe=t,t=A),t!==A)if((r=R())!==A){if(i=[],(n=w())!==A)for(;n!==A;)i.push(n),n=w();else i=A;i!==A?(ve=e,t=Q(r,i),e=t):(pe=e,e=A)}else pe=e,e=A;else pe=e,e=A;if(e===A){if(e=pe,t=pe,be++,r=y(),be--,r===A?t=void 0:(pe=t,t=A),t!==A){if(r=[],(i=R())!==A)for(;i!==A;)r.push(i),i=R();else r=A;r!==A?(ve=e,t=G(r),e=t):(pe=e,e=A)}else pe=e,e=A;if(e===A){if(e=pe,(t=b())!==A){for(r=[],i=C();i!==A;)r.push(i),i=C();r!==A?(i=b(),i!==A?(ve=e,t=K(r),e=t):(pe=e,e=A)):(pe=e,e=A)}else pe=e,e=A;if(e===A)if(e=pe,(t=q())!==A){for(r=[],i=U();i!==A;)r.push(i),i=U();r!==A?(i=q(),i!==A?(ve=e,t=K(r),e=t):(pe=e,e=A)):(pe=e,e=A)}else pe=e,e=A}}return e}function m(){var e,t;return e=pe,t=y(),t!==A&&(ve=e,t=J(t)),e=t}function y(){var e;return t.substr(pe,3)===V?(e=V,pe+=3):(e=A,0===be&&o(Y)),e===A&&(t.substr(pe,2)===$?(e=$,pe+=2):(e=A,0===be&&o(W)),e===A&&(t.substr(pe,3)===X?(e=X,pe+=3):(e=A,0===be&&o(Z)))),e}function b(){var e;return 39===t.charCodeAt(pe)?(e=ee,pe++):(e=A,0===be&&o(te)),e}function C(){var e;return re.test(t.charAt(pe))?(e=t.charAt(pe),pe++):(e=A,0===be&&o(ie)),e}function q(){var e;return 34===t.charCodeAt(pe)?(e=ne,pe++):(e=A,0===be&&o(se)),e}function U(){var e;return ue.test(t.charAt(pe))?(e=t.charAt(pe),pe++):(e=A,0===be&&o(ae)),e}function F(){var e;return oe.test(t.charAt(pe))?(e=t.charAt(pe),pe++):(e=A,0===be&&o(ce)),e}function w(){var e;return de.test(t.charAt(pe))?(e=t.charAt(pe),pe++):(e=A,0===be&&o(le)),e}function R(){var e;return fe.test(t.charAt(pe))?(e=t.charAt(pe),pe++):(e=A,0===be&&o(he)),e}function x(){var e,r;if(e=[],_e.test(t.charAt(pe))?(r=t.charAt(pe),pe++):(r=A,0===be&&o(ge)),r!==A)for(;r!==A;)e.push(r),_e.test(t.charAt(pe))?(r=t.charAt(pe),pe++):(r=A,0===be&&o(ge));else e=A;return e}function S(){var e;return e=x(),e===A&&(e=null),e}r=void 0!==r?r:{};var T,A={},O={start:d},M=d,D=function(e){return e},N=function(e,t,r){return new Pride.FieldTree.FieldBoolean(t,e,r)},E=function(e,t){return t?[e,t]:e},L=function(e){return e},j=":",z=i(":",!1),B=function(e,t){return new Pride.FieldTree.Field(e,t)},k=function(e){return new Pride.FieldTree.Field(Ce,e)},H=function(e){return e.join("")},I=function(e,t){return t?e.concat(t):e},Q=function(e,t){return[new Pride.FieldTree.Literal(e+t.join(""))]},G=function(e){return[new Pride.FieldTree.Literal(e.join(""))]},K=function(e){return[new Pride.FieldTree.Literal('"'+e.join("")+'"')]},J=function(e){return e},V="AND",Y=i("AND",!1),$="OR",W=i("OR",!1),X="NOT",Z=i("NOT",!1),ee="'",te=i("'",!1),re=/^[^']/,ie=n(["'"],!0,!1),ne='"',se=i('"',!1),ue=/^[^"]/,ae=n(['"'],!0,!1),oe=/^[^ \t\r\n:'"()]/,ce=n([" ","\t","\r","\n",":","'",'"',"(",")"],!0,!1),de=/^[^ \t\r\n():]/,le=n([" ","\t","\r","\n","(",")",":"],!0,!1),fe=/^[^ \t\r\n'"():]/,he=n([" ","\t","\r","\n","'",'"',"(",")",":"],!0,!1),_e=/^[ \t\r\n]/,ge=n([" ","\t","\r","\n"],!1,!1),pe=0,ve=0,Pe=[{line:1,column:1}],me=0,ye=[],be=0;if("startRule"in r){if(!(r.startRule in O))throw new Error("Can't start parsing from rule \""+r.startRule+'".');M=O[r.startRule]}var Ce=r.defaultFieldName||"all_fields";if((T=M())!==A&&pe===t.length)return T;throw T!==A&&pe<t.length&&o(function(){return{type:"end"}}()),c(ye,me<t.length?t.charAt(me):null,me<t.length?a(me,me+1):a(me,me))}return function(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}(e,Error),e.buildMessage=function(e,t){function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function i(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+r(e)})}function n(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+r(e)})}function s(e){return u[e.type](e)}var u={literal:function(e){return'"'+i(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?n(e.parts[t][0])+"-"+n(e.parts[t][1]):n(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};return"Expected "+function(e){var t,r,i=new Array(e.length);for(t=0;t<e.length;t++)i[t]=s(e[t]);if(i.sort(),i.length>0){for(t=1,r=1;t<i.length;t++)i[t-1]!==i[t]&&(i[r]=i[t],r++);i.length=r}switch(i.length){case 1:return i[0];case 2:return i[0]+" or "+i[1];default:return i.slice(0,-1).join(", ")+", or "+i[i.length-1]}}(e)+" but "+function(e){return e?'"'+i(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:t}}(),Pride.PreferenceEngine={favoritedRecords:null,favoritedRecordsTags:null,selectedRecords:null,engine:null,favorited:function(e){return!!this.engine&&(this.favoritedRecords[e.datastore]||{})[e.uid]},selected:function(e){return!!this.engine&&(this.selectedRecords[e.datastore]||{})[e.uid]},favoriteTags:function(e){return this.engine?(this.favoritedRecordsTags[e.datastore]||{})[e.uid]||[]:[]},registerEngine:function(e){return this.engine=e,e?(this.updateSelectedRecords(this.engine.listRecords()),this.updateFavoritedRecords(this.engine.favoritesList.last),this.engine.addFavoritesListObserver(function(e){return function(t){e.updateFavoritedRecords(t)}}(this)),this.engine.addObserver(function(e){return function(t){e.updateSelectedRecords(t)}}(this)),this):this},blankList:function(){return{mirlyn:{},articlesplus:{},databases:{},journals:{},website:{}}},updateFavoritedRecords:function(e){return this.favoritedRecords=this.favoritedRecords||this.blankList(),this.favoritedRecordsTags=this.favoritedRecordsTags||this.blankList(),!e||e.length<1||!e.forEach?(this.favoritedRecords=this.blankList(),this.favoritedRecordsTags=this.blankList(),this):(e.forEach(function(e){var t,r,i,n;if((t=e.tags.indexOf("mirlyn-favorite"))>=0)r=e.id[0].split("/")[4],i="mirlyn";else if((t=e.tags.indexOf("articles-favorite"))>=0)r=e.id[0].split("/")[5],i="articlesplus";else if((t=e.tags.indexOf("databases-favorite"))>=0)r=e.id[0].split("/")[4],i="databases";else if((t=e.tags.indexOf("journals-favorite"))>=0)r=e.id[0].split("/")[4],i="journals";else{if(!((t=e.tags.indexOf("website-favorite"))>=0))return this;r=e.id[0],i="website"}n=e.tags.slice(0,t).concat(e.tags.slice(t+1,e.tags.length)),this.favoritedRecords[i][r]=!0,this.favoritedRecordsTags[i][r]=n},this),this)},
updateSelectedRecords:function(e){if(this.selectedRecords=this.selectedRecords||this.blankList(),e.forEach)return e.forEach(function(e){this.selectedRecords[e.datastore]=this.selectedRecords[e.datastore]||{},this.selectedRecords[e.datastore][e.uid]=!0},this),this;for(var t in e)e.hasOwnProperty(t)&&(this.selectedRecords[t]={},e[t].forEach(function(e){return function(t){this.selectedRecords[e][t.uid]=!0}}(t),this));return this}};