"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Pride=exports.Pride={Util:{},Core:{},Settings:{default_cache_size:20,cache_size:{},datastores_url:"",connection_attempts:3,init_attempts:3,ms_between_attempts:1500,message_formats:{failed_record_load:"Failed to load $1",failed_search_run:"Failed to search $1",failed_init:"Failed to initialize Pride"},obnoxious:!1}},_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.Datastore=function(t){t=Pride.Util.deepClone(t),this.baseQuery=function(){return new Pride.Core.Query({uid:t.uid,sort:t.default_sort,start:0,count:0,settings:{},field_tree:e(),facets:_underscore2.default.reduce(t.facets,function(e,t){return t.required&&!t.fixed&&(e[t.uid]=t.default_value),e},{})})},this.baseSearch=function(){return new Pride.Core.DatastoreSearch({datastore:this})},this.runQuery=function(e){return e.url=t.url,Pride.Util.request(e),this},this.get=function(e){return t[e]},this.update=function(e){_underscore2.default.extend(t,e)};var e=function(e){e=e||new Pride.FieldTree.FieldBoolean("AND");e=_underscore2.default.reduce(t.fields,function(e,t){return!t.required&&!t.fixed||e.contains({type:"field",value:t.uid})?e:(missing_field=new Pride.FieldTree.Field(t.uid,new Pride.FieldTree.Literal(t.default_value)),_underscore2.default.isMatch(e,{type:"field_boolean",value:"AND"})?e.addChild(missing_field):new Pride.FieldTree.FieldBoolean("AND",e,missing_field))},e);return e.matches({type:"field_boolean",children:[]})?{}:e}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.DatastoreSearch=function(e){var r=this,n=new Pride.Core.SearchBase(e,this),i=(n.createItem=function(e){return new Pride.Core.Record(e)},[]),t=[];this.getFacets=function(){return i},this.uid=n.datastore.get("uid"),this.getData=function(){return{uid:r.uid,metadata:Pride.Util.deepClone(n.datastore.get("metadata")),sorts:Pride.Util.deepClone(n.datastore.get("sorts")),selected_sort:n.query.get("sort"),facets:Pride.Util.deepClone(n.query.get("facets")),fields:Pride.Util.deepClone(n.datastore.get("fields")),field_tree:Pride.Util.deepClone(n.query.get("field_tree")),settings:Pride.Util.deepClone(n.query.get("settings")),page:n.query.get("page"),count:n.query.get("count"),total_available:n.query.get("total_available"),total_pages:n.query.get("total_pages"),page_limit:n.query.get("page_limit"),specialists:Pride.Util.deepClone(n.query.get("specialists"))}},this.getResults=n.results,n.initialize_observables=function(){r.runDataObservers.add(function(){var e=n.datastore.get("facets");Pride.Util.isDeepMatch(t,e)||(_underscore2.default.each(i,function(e){e.clearAllObservers()}),i=_underscore2.default.map(e,function(e){return new Pride.Core.FacetSearch({data:_underscore2.default.omit(e,"values"),results:e.values})}),t=e,r.facetsObservers.notify())})},this.getMute=n.getMute,this.setMute=function(t){return _underscore2.default.each(i,function(e){e.setMute(t)}),n.setMute(t),r},n.createObservable("facets",this.getFacets).initialize_observables()};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.FacetSearch=function(e){function t(r,n){return new Pride.Util.FuncBuffer(function(){var t=this.add,e=this.call;u.push(this),this.add=function(e){return self.muted||e(n()),t(e,"observers"),this},this.notify=function(){return self.muted||(i=n(),self.log("NOTIFY ("+r+")",i),e("observers",i)),this}})}var i=e.data,r=e.results,n=(this.uid=i.uid,this.getData=function(){return i},!(this.getResults=function(){return r})),u=(this.getMute=function(){return n},this.setMute=function(e){return n=e,self},[]);this.clearAllObservers=function(){return _underscore2.default.each(u,function(e){e.clearAll()}),self};this.resultsObservers=t("results",this.getResults),this.setDataObservers=t("setData",this.getData),this.runDataObservers=t("runData",this.getData)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.FieldTree={},Pride.Core.nodeFactory=function(t,r,n){return function(e){this.children=Pride.Util.slice(arguments,1),1===this.children.length&&Array.isArray(this.children[0])&&(this.children=this.children[0]),this.type=t,this.value=e.trim(),this.child_types=r||[],this.validIfEmpty=!0,this.addChild=function(t){if(_underscore2.default.find(this.child_types,function(e){return t.type===e}))return this.children.push(t),this;throw"Not a valid child for a "+this.type},this.contains=function(t){return this.matches(t)?this:!_underscore2.default.isEmpty(this.children)&&_underscore2.default.find(this.children,function(e){return e.contains(t)})},this.matches=function(e){var r=this,t=e.children||[];return _underscore2.default.every(_underscore2.default.omit(e,"children"),function(e,t){return r[t]==e})&&_underscore2.default.every(t,function(t){return _underscore2.default.any(children,function(e){return t.matches(e)})})},this.serialize=function(){return e},this.serializedChildren=function(){return _underscore2.default.chain(this.children).map(function(e){return e.serialize()}).compact().value()},this.toJSON=function(){return _underscore2.default.mapObject(_underscore2.default.pick(this,"value","children","type"),function(e,t){return"children"==t?_underscore2.default.map(e,function(e){return e.toJSON()}):e})},_underscore2.default.isFunction(n)&&n.call(this)}},Pride.Core.boolNodeFactory=function(e,t){return Pride.Core.nodeFactory(e,t,function(){if(!_underscore2.default.contains(["AND","OR","NOT"],this.value))throw"Not a valid boolean value";this.serialize=function(){return this.serializedChildren().join(" "+this.value+" ")},this.serializedChildren=function(){var t=this;return _underscore2.default.chain(t.children).map(function(e){return e.type==t.type||"literal"==e.type&&e.value.match(/\s/)?"("+e.serialize()+")":e.serialize()}).compact().value()}})};var top_level_nodes=["field_boolean","field"],inside_field_nodes=["value_boolean","literal","tag","special"],_underscore=(Pride.FieldTree.FieldBoolean=Pride.Core.boolNodeFactory("field_boolean",top_level_nodes),Pride.FieldTree.ValueBoolean=Pride.Core.boolNodeFactory("value_boolean",inside_field_nodes),Pride.FieldTree.Field=Pride.Core.nodeFactory("field",inside_field_nodes,function(){this.serialize=function(){return this.value+": ("+this.serializedChildren().join(" ")+")"}}),Pride.FieldTree.Tag=Pride.Core.nodeFactory("tag",inside_field_nodes,function(){this.serialize=function(){var e=this.serializedChildren();return 0===e.length?"":this.value+"("+e.join(" ")+")"}}),Pride.FieldTree.Literal=Pride.Core.nodeFactory("literal"),Pride.FieldTree.Special=Pride.Core.nodeFactory("special"),Pride.FieldTree.Raw=Pride.Core.nodeFactory("raw"),require("underscore")),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.FuncBuffer=function(e){function r(e){return _underscore2.default.has(n,e)||(n[e]=[]),n[e]}var n={},i=this;this.add=function(e,t){return r(t).push(e),i},this.remove=function(t,e){return n[e]=_underscore2.default.reject(r(e),function(e){return t==e}),i},this.clear=function(e){return delete n[e],i},this.clearAll=function(){return n={},i},this.call=function(e){return i.apply(e,Pride.Util.slice(arguments,1)),i},this.apply=function(e,t){return _underscore2.default.each(r(e),function(e){Pride.Util.safeApply(e,t)}),i},_underscore2.default.isFunction(e)&&e.call(this)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.GetThis=function(e,t){this.barcode=e,this.data=t;var r,n=new Pride.Util.RequestBuffer({url:(e=t,_underscore2.default.each(e.fields,function(e){"get_this_url"===e.uid&&(r=e.value)}),r+"/"+this.barcode),failure_message:Pride.Messenger.preset("failed_get_this_load",t.names[0]),edit_response:function(e){return t=i(e)}}),i=function(e){return e};this.getData=function(e){n.request({success:e})}},Pride.Core.Holdings=function(t){this.data=t;this.getData=function(e){Pride.Util.safeCall(e,(e=this.data.holdings,[function(e){e=e.fields.find(function(e){return"resource_access"===e.uid});return e&&e.value?e.value:e}(t)].concat(e)))}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.MultiSearch=function(e,t,n){function r(r,e){return function(){var t=Pride.Util.slice(arguments);return Pride.Util.safeApply(e,t),_underscore2.default.each(n,function(e){e[r].apply(e,t)}),u}}var i={},u=this;this.searches=n,this.uid=e,this.set=function(t){return _underscore2.default.extend(i,t),_underscore2.default.each(n,function(e){e.set(t)}),u};this.run=r("run"),this.nextPage=r("nextPage"),this.prevPage=r("prevPage"),this.setMute=r("setMute",function(e){t=e}),this.getMute=function(){return t},this.setMute(t)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.Paginater=function(e){this.set=function(e){if(_underscore2.default.has(e,"total_pages"))throw"Can not set total_pages (it is a calculated value)";if(_underscore2.default.has(e,"index_limit"))throw"Can not set index_limit (it is a calculated value)";if(2<_underscore2.default.intersection(["start","end","count"],_underscore2.default.keys(e)).length)throw"Can not set start, end and count all at the same time";if(_underscore2.default.has(e,"page")&&(_underscore2.default.has(e,"start")||_underscore2.default.has(e,"end")))throw"Can not set page as well as the start and/or end";if(_underscore2.default.extend(t,_underscore2.default.omit(e,"end")),_underscore2.default.has(e,"page")&&(t.start=(t.count||0)*(t.page-1)),_underscore2.default.has(e,"end")){if(_underscore2.default.has(e,"count"))t.start=Math.max(0,e.end-(t.count-1));else{if(!(t.start<=e.end))throw"The start value can not be greater than the end value";t.count=e.end-t.start+1}t.end=e.end}else{e=t.start+t.count-1;t.end=e<t.start?void 0:e}if(_underscore2.default.isNumber(t.total_available)?0<t.total_available?t.index_limit=t.total_available-1:t.index_limit=void 0:t.index_limit=1/0,0<t.count&&t.start%t.count==0?(t.page=Math.floor(t.start/t.count)+1,_underscore2.default.isNumber(t.total_available)?(t.total_pages=Math.ceil(t.total_available/t.count),t.page_limit=t.total_pages):(t.total_pages=void 0,t.page_limit=1/0)):(t.page=void 0,t.total_pages=void 0,t.page_limit=void 0),_underscore2.default.has(t,"start")&&_underscore2.default.has(t,"count"))return this;throw"Not enough information given to create Paginater"},this.get=function(e){return t[e]};var t={};this.set(e)},Pride.Util.Paginater.getPossibleKeys=function(){return["start","count","end","page","index_limit","total_pages","total_available","page_limit"]},Pride.Util.Paginater.hasKey=function(e){return-1<Pride.Util.Paginater.getPossibleKeys().indexOf(e)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.Query=function(r){var n=new Pride.Util.Paginater({start:r.start,count:r.count}),i=Pride.Util.Paginater.getPossibleKeys();(r=_underscore2.default.omit(Pride.Util.deepClone(r),i)).request_id=r.request_id||0,this.get=function(e){return Pride.Util.Paginater.hasKey(e)?n.get(e):r[e]},this.set=function(e){var t=_underscore2.default.pick(e,i),e=_underscore2.default.omit(e,i);return _underscore2.default.isEmpty(e)||(n.set({total_available:void 0}),_underscore2.default.isNumber(e.request_id))||(r.request_id+=1),n.set(t),_underscore2.default.extend(r,e),this},this.clone=function(){var e=Pride.Util.deepClone(r);return e.start=n.get("start"),e.count=n.get("count"),new Pride.Core.Query(e)},this.toSection=function(){return new Pride.Util.Section(this.get("start"),this.get("end"))},this.toLimitSection=function(){return new Pride.Util.Section(this.get("start"),this.get("index_limit"))},this.toJSON=function(){return{uid:this.get("uid"),request_id:this.get("request_id"),start:this.get("start"),count:this.get("count"),field_tree:this.get("field_tree"),facets:this.get("facets"),sort:this.get("sort"),settings:this.get("settings"),raw_query:this.get("raw_query")}}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.Record=function(n){var i=new Pride.Util.RequestBuffer({url:n.source,failure_message:Pride.Messenger.preset("failed_record_load",n.names[0]),edit_response:function(e){return n=s(e)}}),r=null,u={},t=(this.placeHold=function(r,n,i,u){this.renderFull(function(e){var t;Pride.Util.request({url:[(_underscore2.default.each(e.fields,function(e){"holdings_url"===e.uid&&(t=e.value)}),t),r,n,i].join("/"),query:!0,failure:function(e){Pride.Messenger.sendMessage({summary:"Failed to place hold",class:"error"})},success:u,failure_message:"placeHold failed",success_message:"placeHold succeeded"})})},this.getHoldings=function(t){r?r.getData(t):n.complete?(r=new Pride.Core.Holdings(n)).getData(t):i.request({success:function(e){(r=new Pride.Core.Holdings(e)).getData(t)}})},this.getGetThis=function(t,r){u[t]?u[t].getData(r):n.complete?(u[t]=new Pride.Core.GetThis(t,n),u[t].getData(r)):i.request({success:function(e){u[t]=new Pride.Core.GetThis(t,e),u[t].getData(r)}})},this.renderPart=function(e){t(e)},this.renderPartThenCache=function(e){t(e),i.request()},this.renderFull=function(e){n.complete?t(e):i.request({success:e})},this.renderCSL=function(r){this.renderFull(function(e){var t;_underscore2.default.each(e.fields,function(e){"csl"===e.uid&&(t=e.value)}),r(t)})},function(e){e(_underscore2.default.omit(n,"complete","source"),n.complete)}),s=function(e){return e.fields=_underscore2.default.map(e.fields,function(e){return e.value_has_html||(e.value=Pride.Util.escape(e.value)),_underscore2.default.omit(e,"value_has_html")}),e.names_have_html||(e.names=_underscore2.default.map(e.names,function(e){return Pride.Util.escape(e)})),e.uid?e.status=200:e.status=404,Pride.PreferenceEngine.selected(e)&&(e.selected=!0),_underscore2.default.omit(e,"names_have_html")};n=s(n)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.RequestBuffer=function(t){t=t||{};var r,n=new Pride.Util.FuncBuffer,i=!1,u=!1,s=!1,a=(this.request=function(e){return n.add(e.success,"success").add(e.failure,"failure"),(i?a:o)(),this},function(e){r=e||r,u?d("success"):s&&d("failure")}),o=function(){i=!0,Pride.Util.request({url:Pride.Util.safeCall(t.url),attempts:Pride.Util.safeCall(t.attempts)||Pride.Settings.connection_attempts,failure_message:Pride.Util.safeCall(t.failure_message),failure:function(e){s=!0,Pride.Util.safeCall(t.before_failure,e),a(e),Pride.Util.safeCall(t.after_failure,e)},success:function(e){u=!0,Pride.Util.safeCall(t.before_success,e),_underscore2.default.isFunction(t.edit_response)&&(e=t.edit_response(e)),a(e),Pride.Util.safeCall(t.after_success,e)}})},d=function(e){n.call(e,r).clearAll()}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Core.SearchBase=function(e,r){this.datastore=e.datastore,this.query=e.query||this.datastore.baseQuery();var s=this,i=e.requestFunc||this.datastore.runQuery,u=e.starting_results||[],t=e.cache_size||Pride.Settings.cache_size[this.datastore.uid]||Pride.Settings.default_cache_size,n=(this.log=function(){var e=Pride.Util.slice(arguments);e.unshift("Search ("+s.datastore.get("uid")+")"),Pride.Core.log.apply(window,e)},this.set=function(e){return s.query.set(e),Pride.Util.safeCall(s.setDataChanged),_underscore2.default.isEmpty(_underscore2.default.omit(e,Pride.Util.Paginater.getPossibleKeys()))||(u=[]),s},this.run=function(e){return Pride.Util.safeCall(s.resultsChanged),_underscore2.default.isUndefined(e)&&(e=t),n(d(s.query.toSection().expanded(e))),s},this.results=function(){return l(new Pride.Util.Section(s.query.get("start"),Math.min(s.query.get("end"),s.query.get("index_limit"))))},function t(r){var n;s.log("REQUESTING",r),s.log("TOTAL AVAILABLE (pre-request)",s.query.get("total_available")),r&&s.query.toLimitSection().overlaps(r)?(s.log("Sending query..."),n=s.query.clone().set({start:r.start,count:r.calcLength()}),i({query:n,failure_message:Pride.Messenger.preset("failed_search_run",s.datastore.get("metadata").name),success:function(e){e.request.request_id==s.query.get("request_id")&&(o(e),a(e.response,n.get("start")),0!==(e=e.response.length))&&e<n.get("count")&&t(r.shifted(e,0))}})):Pride.Util.safeCall(s.runDataChanged)}),a=function(e,r){var n=!1;s.log("NEW RECORDS",e),_underscore2.default.each(e,function(e,t){t+=r;_underscore2.default.isUndefined(u[t])&&(u[t]=Pride.Util.safeCall(s.createItem,e),s.query.toSection().inSection(t))&&(n=!0)}),s.log("CACHE LENGTH",u.length),(n||_underscore2.default.isEmpty(e))&&Pride.Util.safeCall(s.resultsChanged)},o=function(e){s.datastore.update(e.datastore);var t=_underscore2.default.omit(e.new_request,"start","count");t.specialists=e.specialists,t.total_available=e.total_available,s.query.set(t),Pride.Util.safeCall(s.runDataChanged)},d=function(e){var t=l(e),r=_underscore2.default.indexOf(t,void 0);if(-1!=r)return t=e.start+_underscore2.default.lastIndexOf(t,void 0),r+=e.start,new Pride.Util.Section(r,t)},l=function(e){for(var t=[],r=e.start;r<=e.end;r++)t.push(u[r]);return t},c=!1,f=[],h=[];this.clearAllObservers=function(){return _underscore2.default.each(f,function(e){e.clearAll()}),Pride.Util.safeCall(s.initialize_observables),s},this.getMute=function(){return c},this.setMute=function(e){return e!=c&&(c=e,Pride.Util.safeCall(s.muteChanged()),c||_underscore2.default.each(h,function(e){e.notify()})),s},this.createObservable=function(n,i,u){var e=new Pride.Util.FuncBuffer(function(){var t=this.add,r=this.call;f.push(this),u||h.push(this),this.add=function(e){return s.muted&&!u||e(i()),t(e,"observers"),this},this.notify=function(){var e;return s.muted&&!u||(e=i(),s.log("NOTIFY ("+n+")",e),r("observers",e)),this}});return s[n+"Changed"]=e.notify,r[n+"Observers"]=e,s},this.createObservable("mute",this.getMute,!0).createObservable("setData",function(){r.getData()}).createObservable("runData",function(){r.getData()}).createObservable("results",this.results),r.set=function(e){return s.set(e),r},r.run=function(e){return s.run(e),r},r.nextPage=function(e){var t=s.query.get("page");return _underscore2.default.isNumber(t)&&t<s.query.get("page_limit")&&(r.set({page:t+1}),r.run(e)),r},r.prevPage=function(e){var t=s.query.get("page");return _underscore2.default.isNumber(t)&&1<t&&(r.set({page:t-1}),r.run(e)),r}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.SearchSwitcher=function(r,e){var n=this,i=new Pride.Util.MultiSearch(null,!0,e);r.set({page:1}).setMute(!1),i.set({page:1}),this.uid=r.uid,this.run=function(e){return r.run(e),i.run(0),n},this.set=function(e){return r.set(e),i.set(_underscore2.default.omit(e,"page","facets")),n},this.nextPage=function(){return r.nextPage(),n},this.prevPage=function(){return r.prevPage(),n},this.switchTo=function(t){if(t!=r){if(r.setMute(!0).set({page:1}),i.searches.push(r),r=void 0,i.searches=_underscore2.default.reject(i.searches,function(e){if(e.uid==t)return r=e,!0}),!r)throw"Could not find a search with a UID of: "+t;n.uid=r.uid,r.setMute(!1)}return n}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.Section=function(e,t){this.start=Math.max(Math.min(e,t),0),this.end=Math.max(Math.max(e,t),0),this.inSection=function(e){return e>=this.start&&e<=this.end},this.overlaps=function(e){return this.inSection(e.start)||this.inSection(e.end)},this.calcLength=function(){return this.end-this.start+1},this.expanded=function(e){return this.shifted(-1*e,e)},this.shifted=function(e,t){return _underscore2.default.isNumber(t)||(t=e),new Pride.Util.Section(this.start+e,this.end+t)}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.deepClone=function(e){var t;return _underscore2.default.isFunction(e)?e:(t=!1,_underscore2.default.isArray(e)?t="map":_underscore2.default.isObject(e)&&(t="mapObject"),t?_underscore2.default[t](e,function(e){return Pride.Util.deepClone(e)}):_underscore2.default.clone(e))},Pride.Util.escape=function(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.init=new Pride.Util.RequestBuffer({url:function(){return Pride.Settings.datastores_url},attempts:function(){return Pride.Settings.init_attempts},failure_message:function(){return Pride.Messenger.preset("failed_init")},edit_response:function(){},before_success:function(e){Pride.Settings.default_institution=e.default_institution,Pride.Settings.affiliation=e.affiliation,Pride.AllDatastores.array=_underscore2.default.map(e.response,function(e){return new Pride.Core.Datastore(e)})}}).request;_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.isDeepMatch=function(r,e){var t=_underscore2.default.isArray(r)&&_underscore2.default.isArray(e),n=_underscore2.default.isObject(r)&&_underscore2.default.isObject(e);return!(t&&e.length!=r.length||n&&_underscore2.default.keys(e).length!=_underscore2.default.keys(r).length)&&(t||n?_underscore2.default.every(e,function(e,t){return Pride.Util.isDeepMatch(r[t],e)}):r===e)},Pride.Core.log=function(e,t){var r;Pride.Settings.obnoxious&&((r=Pride.Util.slice(arguments,2)).unshift("[Pride: "+e+"] "+t),console.log.apply(console,r))},Pride.FieldTree.parseField=function(e,t){if(!t)return{};try{return Pride.Parser.parse(t,{defaultFieldName:e})}catch(e){return console.log(e),new Pride.FieldTree.Raw(t)}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.FieldTree=Pride.FieldTree||{},Pride.FieldTree.tokens=[":","AND","OR","+","-","(",")","*"," ","\n","\t","\r"],Pride.FieldTree.tokenize=function(e){for(var t=[],r=0,n=null;r<e.length;){var i,u=e.slice(r),s=_underscore2.default.find(Pride.FieldTree.tokens,function(e){return new RegExp("^\\"+e).exec(u)});s?(/\s/.exec(s)&&(n="whitespace"),r+=(n=s).length):(s=e.charAt(r),n="string",r++,(i=_underscore2.default.last(t))&&"string"==i.type&&(s=t.pop().content+s)),t.push({type:n,content:s})}return t};var _underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore),_reqwest=require("reqwest"),_reqwest2=_interopRequireDefault(_reqwest);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.request=function(t){if(Pride.Core.log("Request","Sending HTTP request..."),Pride.Core.log("Request","URL",t.url),Pride.Core.log("Request","CONTENT",JSON.stringify(t.query)),!t.url)throw"No URL given to Pride.Util.request()";var e="get";t.query&&(e="post"),_underscore2.default.isNumber(t.attempts)||(t.attempts=Pride.Settings.connection_attempts),--t.attempts,(0,_reqwest2.default)({url:t.url,data:JSON.stringify(t.query),type:"json",method:e,contentType:"application/json",withCredentials:!0,error:function(e){t.attempts<=0?(Pride.Core.log("Request","ERROR",e),Pride.Util.safeCall(t.failure,e),Pride.Messenger.sendMessage({summary:t.failure_message,class:"error"})):(Pride.Core.log("Request","Trying request again..."),window.setTimeout(function(){Pride.Util.request(t)},Pride.Settings.ms_between_attempts))},success:function(e){Pride.Core.log("Request","SUCCESS",e),Pride.Util.safeCall(t.success,e),Pride.Messenger.sendMessage({summary:t.success_message,class:"success"}),Pride.Messenger.sendMessageArray(e.messages)}})},Pride.requestRecord=function(e,t,r){void 0===r&&(r=function(e){});e={complete:!1,source:Pride.AllDatastores.get(e).get("url")+"/record/"+t,names:[void 0]},t=new Pride.Core.Record(e);return t.renderFull(r),t};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Util.safeCall=function(e){return _underscore2.default.isFunction(e)?e.apply(this,Pride.Util.slice(arguments,1)):e},Pride.Util.safeApply=function(e,t){return _underscore2.default.isFunction(e)?e.apply(this,t):e},Pride.Util.slice=function(e,t,r){return Array.prototype.slice.call(e,t,r)};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.AllDatastores={array:[],get:function(t){return _underscore2.default.find(this.array,function(e){return e.get("uid")==t})},newSearch:function(t){var e=_underscore2.default.find(this.array,function(e){return e.get("uid")==t});return e?e.baseSearch():void 0},each:function(e){return _underscore2.default.each(this.array,e),this}};_underscore=require("underscore"),_underscore2=_interopRequireDefault(_underscore);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Pride.Messenger=new Pride.Util.FuncBuffer(function(){var t=this.call;this.addObserver=this.add,this.removeObserver=this.remove,this.clearObservers=this.clear,this.call=void 0,this.add=void 0,this.remove=void 0,this.clear=void 0,this.sendMessage=function(e){return e.summary&&(e.class=e.class||"info",e.details=e.details||"",t(e.class,e),Pride.Core.log("Messenger","MESSAGE SENT",e)),this},this.sendMessageArray=function(e){var t=this;return _underscore2.default.each(e,function(e){t.sendMessage(e)}),this},this.preset=function(e){}}),Pride.Parser=function(){function he(e,t,r,n){this.message=e,this.expected=t,this.found=r,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,he)}function e(){this.constructor=t}var t,r;return t=he,r=Error,e.prototype=r.prototype,t.prototype=new e,he.buildMessage=function(e,t){var u={literal:function(e){return'"'+n(e.text)+'"'},class:function(e){for(var t="",r=0;r<e.parts.length;r++)t+=e.parts[r]instanceof Array?i(e.parts[r][0])+"-"+i(e.parts[r][1]):i(e.parts[r]);return"["+(e.inverted?"^":"")+t+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function r(e){return e.charCodeAt(0).toString(16).toUpperCase()}function n(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+r(e)})}function i(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+r(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+r(e)})}return"Expected "+function(e){for(var t,r,n=new Array(e.length),i=0;i<e.length;i++)n[i]=(r=e[i],u[r.type](r));if(n.sort(),0<n.length){for(t=i=1;i<n.length;i++)n[i-1]!==n[i]&&(n[t]=n[i],t++);n.length=t}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(e)+" but "+((e=t)?'"'+n(e)+'"':"end of input")+" found."},{SyntaxError:he,parse:function(n,e){function i(e,t){return t?[e,t]:e}function E(e){return e.join("")}function z(e,t){return t?e.concat(t):e}function j(e){return e}var u={},t={start:b},r=b,L=function(e){return e},B=function(e,t,r){return new Pride.FieldTree.FieldBoolean(t,e,r)},s=function(e){return e},k=":",H=v(":",!1),I=function(e,t){return new Pride.FieldTree.Field(e,t)},Q=function(e){return new Pride.FieldTree.Field(fe,e)},G=function(e,t){return[new Pride.FieldTree.Literal(e+t.join(""))]},K=function(e){return[new Pride.FieldTree.Literal(e.join(""))]},a=function(e){return[new Pride.FieldTree.Literal('"'+e.join("")+'"')]},o="AND",J=v("AND",!1),d="OR",V=v("OR",!1),l="NOT",Y=v("NOT",!1),$="'",W=v("'",!1),X=/^[^']/,Z=m(["'"],!0,!1),ee='"',te=v('"',!1),re=/^[^"]/,ne=m(['"'],!0,!1),ie=/^[^ \t\r\n:'"()]/,ue=m([" ","\t","\r","\n",":","'",'"',"(",")"],!0,!1),se=/^[^ \t\r\n():]/,ae=m([" ","\t","\r","\n","(",")",":"],!0,!1),oe=/^[^ \t\r\n'"():]/,de=m([" ","\t","\r","\n","'",'"',"(",")",":"],!0,!1),c=/^[ \t\r\n]/,f=m([" ","\t","\r","\n"],!1,!1),h=0,_=[{line:1,column:1}],g=0,p=[],P=0;if("startRule"in(e=void 0!==e?e:{})){if(!(e.startRule in t))throw new Error("Can't start parsing from rule \""+e.startRule+'".');r=t[e.startRule]}function v(e,t){return{type:"literal",text:e,ignoreCase:t}}function m(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function q(e){var t,r=_[e];if(r)return r;for(t=e-1;!_[t];)t--;for(r={line:(r=_[t]).line,column:r.column};t<e;)10===n.charCodeAt(t)?(r.line++,r.column=1):r.column++,t++;return _[e]=r}function y(e,t){var r=q(e),n=q(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:n.line,column:n.column}}}function C(e){h<g||(g<h&&(g=h,p=[]),p.push(e))}function le(e,t,r){return new he(he.buildMessage(e,t),e,t,r)}function b(){var e=h,t=function e(){var t,r,n,i;t=h;r=D();t=r!==u&&(n=N(),n!==u)&&(n=ce())!==u&&N()!==u&&(i=e())!==u?r=B(r,n,i):(h=t,u);t===u&&(t=R());return t}();return e=t!==u&&function(){var e;(e=N())===u&&(e=null);return e}()!==u?L(t):(h=e,u)}function R(){var e,t,r=D();return r===u&&(r=h,r=(e=D())!==u&&(t=(t=function(){var e,t;e=h,e=N()!==u&&(t=R(),t!==u)?s(t):(h=e,u);return e}())===u?null:t)!==u?i(e,t):(h=r,u)),r}function D(){var e,t=h,r=function(){var e,t,r;if(e=h,t=[],(r=A())!==u)for(;r!==u;)t.push(r),r=A();else t=u;t!==u&&(t=E(t));return e=t}();return(t=r!==u&&(58===n.charCodeAt(h)?(e=k,h++):(e=u,0===P&&C(H)),e!==u)&&(e=U())!==u?r=I(r,e):(h=t,u))===u&&(t=h,(r=U())!==u&&(r=Q(r)),t=r),t}function U(){var e,t=h,r=function(){var e,t,r,n,i;t=e=h,P++,r=w(),P--,t=r===u?void 0:(h=t,u);if(t!==u)if((r=O())!==u){if(n=[],(i=T())!==u)for(;i!==u;)n.push(i),i=T();else n=u;e=n!==u?t=G(r,n):(h=e,u)}else h=e,e=u;else h=e,e=u;if(e===u){if(t=e=h,P++,r=w(),P--,(t=r===u?void 0:(h=t,u))!==u){if(r=[],(n=O())!==u)for(;n!==u;)r.push(n),n=O();else r=u;e=r!==u?t=K(r):(h=e,u)}else h=e,e=u;if(e===u){if(e=h,(t=F())!==u){for(r=[],n=M();n!==u;)r.push(n),n=M();e=r!==u&&(n=F())!==u?t=a(r):(h=e,u)}else h=e,e=u;if(e===u)if(e=h,(t=S())!==u){for(r=[],n=x();n!==u;)r.push(n),n=x();e=r!==u&&(n=S())!==u?t=a(r):(h=e,u)}else h=e,e=u}}return e}();return t=r!==u&&(e=(e=function(){var e,t;e=h,e=N()!==u&&(t=U(),t!==u)?s(t):(h=e,u);return e}())===u?null:e)!==u?z(r,e):(h=t,u)}function ce(){var e=h,t=w();return t!==u&&(t=j(t)),t}function w(){var e;return n.substr(h,3)===o?(e=o,h+=3):(e=u,0===P&&C(J)),e===u&&(n.substr(h,2)===d?(e=d,h+=2):(e=u,0===P&&C(V)),e===u)&&(n.substr(h,3)===l?(e=l,h+=3):(e=u,0===P&&C(Y))),e}function F(){var e;return 39===n.charCodeAt(h)?(e=$,h++):(e=u,0===P&&C(W)),e}function M(){var e;return X.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(Z)),e}function S(){var e;return 34===n.charCodeAt(h)?(e=ee,h++):(e=u,0===P&&C(te)),e}function x(){var e;return re.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(ne)),e}function A(){var e;return ie.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(ue)),e}function T(){var e;return se.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(ae)),e}function O(){var e;return oe.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(de)),e}function N(){var e,t=[];if(c.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(f)),e!==u)for(;e!==u;)t.push(e),c.test(n.charAt(h))?(e=n.charAt(h),h++):(e=u,0===P&&C(f));else t=u;return t}var fe=e.defaultFieldName||"all_fields";if((t=r())!==u&&h===n.length)return t;throw t!==u&&h<n.length&&C({type:"end"}),le(p,g<n.length?n.charAt(g):null,g<n.length?y(g,g+1):y(g,g))}}}(),Pride.PreferenceEngine={selectedRecords:null,engine:null,selected:function(e){return!!this.engine&&(this.selectedRecords[e.datastore]||{})[e.uid]},registerEngine:function(e){var t;return(this.engine=e)&&(this.updateSelectedRecords(this.engine.listRecords()),this.engine.addObserver((t=this,function(e){t.updateSelectedRecords(e)}))),this},blankList:function(){return{mirlyn:{},articlesplus:{},databases:{},journals:{},website:{}}},updateSelectedRecords:function(e){if(this.selectedRecords=this.selectedRecords||this.blankList(),e.forEach)e.forEach(function(e){this.selectedRecords[e.datastore]=this.selectedRecords[e.datastore]||{},this.selectedRecords[e.datastore][e.uid]=!0},this);else for(var t in e)e.hasOwnProperty(t)&&(this.selectedRecords[t]={},e[t].forEach(function(t){return function(e){this.selectedRecords[t][e.uid]=!0}}(t),this));return this}};