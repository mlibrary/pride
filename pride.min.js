Pride={},Pride.Util={},Pride.Core={},Pride.Settings={default_cache_size:100,cache_size:{},datastores_url:"",connection_attempts:3,init_attempts:3,ms_between_attempts:1500,message_formats:{failed_record_load:"Failed to load $1",failed_search_run:"Failed to search $1",failed_init:"Failed to initialize Pride"},obnoxious:!1},Pride.Core.Datastore=function(e){e=Pride.Util.deepClone(e),this.baseQuery=function(){return new Pride.Core.Query({uid:e.uid,sort:e.default_sort,start:0,count:0,settings:{},field_tree:t(),facets:_.reduce(e.facets,function(e,t){return t.required&&!t.fixed&&(e[t.uid]=t.default_value),e},{})})},this.baseSearch=function(){return new Pride.Core.DatastoreSearch({datastore:this})},this.runQuery=function(t){return t.url=e.url,Pride.Util.request(t),this},this.get=function(t){return"url"!=t?e[t]:void 0},this.update=function(t){_.extend(e,t)};var t=function(t){return t=t||new Pride.FieldTree.FieldBoolean("AND"),output=_.reduce(e.fields,function(e,t){return!t.required&&!t.fixed||e.contains({type:"field",value:t.uid})?e:(missing_field=new Pride.FieldTree.Field(t.uid,new Pride.FieldTree.Literal(t.default_value)),_.isMatch(e,{type:"field_boolean",value:"AND"})?e.addChild(missing_field):new Pride.FieldTree.FieldBoolean("AND",e,missing_field))},t),output.matches({type:"field_boolean",children:[]})?{}:output}},Pride.Core.DatastoreSearch=function(e){var t=this,i=new Pride.Core.SearchBase(e,this);i.createItem=function(e){return new Pride.Core.Record(e)};var r=[],n=[];this.getFacets=function(){return r},this.uid=i.datastore.get("uid"),this.getData=function(){return{uid:t.uid,metadata:Pride.Util.deepClone(i.datastore.get("metadata")),sorts:Pride.Util.deepClone(i.datastore.get("sorts")),selected_sort:i.query.get("sort"),facets:Pride.Util.deepClone(i.query.get("facets")),fields:Pride.Util.deepClone(i.datastore.get("fields")),field_tree:Pride.Util.deepClone(i.query.get("field_tree")),settings:Pride.Util.deepClone(i.query.get("settings")),page:i.query.get("page"),count:i.query.get("count"),total_available:i.query.get("total_available"),total_pages:i.query.get("total_pages"),page_limit:i.query.get("page_limit")}},this.getResults=i.results,i.initialize_observables=function(){t.runDataObservers.add(function(){var e=i.datastore.get("facets");Pride.Util.isDeepMatch(n,e)||(_.each(r,function(e){e.clearAllObservers()}),r=_.map(e,function(e){return new Pride.Core.FacetSearch({data:_.omit(e,"values"),results:e.values})}),n=e,t.facetsObservers.notify())})},this.getMute=i.getMute,this.setMute=function(e){return _.each(r,function(t){t.setMute(e)}),i.setMute(e),t},i.createObservable("facets",this.getFacets).initialize_observables()},Pride.Core.FacetSearch=function(e){example_facet=this;var t=e.data,i=e.results;this.uid=t.uid,this.getData=function(){return t},this.getResults=function(){return i};var r=!1;this.getMute=function(){return r},this.setMute=function(e){return r=e,self};var n=[];this.clearAllObservers=function(){return _.each(n,function(e){e.clearAll()}),self};var s=function(e,i){var r=new Pride.Util.FuncBuffer(function(){var r=this.add,s=this.call;n.push(this),this.add=function(e){return self.muted||e(i()),r(e,"observers"),this},this.notify=function(){return self.muted||(t=i(),self.log("NOTIFY ("+e+")",t),s("observers",t)),this}});return r};this.resultsObservers=s("results",this.getResults),this.setDataObservers=s("setData",this.getData),this.runDataObservers=s("runData",this.getData)},Pride.FieldTree={},Pride.Core.nodeFactory=function(e,t,i){return function(r){this.children=Pride.Util.slice(arguments,1),this.type=e,this.value=r.trim(),this.child_types=t||[],this.validIfEmpty=!0,this.addChild=function(e){if(!_.find(this.child_types,function(t){return e.type===t}))throw"Not a valid child for a "+this.type;return this.children.push(e),this},this.contains=function(e){return this.matches(e)?this:_.isEmpty(this.children)?!1:_.find(this.children,function(t){return t.contains(e)})},this.matches=function(e){var t=this,i=e.children||[];return _.every(_.omit(e,"children"),function(e,i){return t[i]==e})&&_.every(i,function(e){return _.any(children,function(t){return e.matches(t)})})},this.serialize=function(){return r},this.serializedChildren=function(){return _.chain(this.children).map(function(e){return e.serialize()}).compact().value()},this.toJSON=function(){return _.pick(this,"value","children","type")},_.isFunction(i)&&i.call(this)}},Pride.Core.boolNodeFactory=function(e,t){return Pride.Core.nodeFactory(e,t,function(){if(!_.contains(["AND","OR","NOT"],this.value))throw"Not a valid boolean value";this.serialize=function(){return this.serializedChildren().join(" "+this.value+" ")},this.serializedChildren=function(){var e=this;return _.chain(e.children).map(function(t){return t.type==e.type||"literal"==t.type&&t.value.match(/\s/)?"("+t.serialize()+")":t.serialize()}).compact().value()}})};var top_level_nodes=["field_boolean","field"],inside_field_nodes=["value_boolean","literal","tag","special"];Pride.FieldTree.FieldBoolean=Pride.Core.boolNodeFactory("field_boolean",top_level_nodes),Pride.FieldTree.ValueBoolean=Pride.Core.boolNodeFactory("value_boolean",inside_field_nodes),Pride.FieldTree.Field=Pride.Core.nodeFactory("field",inside_field_nodes,function(){this.serialize=function(){return this.value+": ("+this.serializedChildren().join(" ")+")"}}),Pride.FieldTree.Tag=Pride.Core.nodeFactory("tag",inside_field_nodes,function(){this.serialize=function(){var e=this.serializedChildren();return 0===e.length?"":this.value+"("+e.join(" ")+")"}}),Pride.FieldTree.Literal=Pride.Core.nodeFactory("literal"),Pride.FieldTree.Special=Pride.Core.nodeFactory("special"),Pride.Util.FuncBuffer=function(e){var t={},i=this,r=function(e){return _.has(t,e)||(t[e]=[]),t[e]};this.add=function(e,t){return r(t).push(e),i},this.remove=function(e,n){return t[n]=_.reject(r(n),function(t){return e==t}),i},this.clear=function(e){return delete t[e],i},this.clearAll=function(){return t={},i},this.call=function(e){return i.apply(e,Pride.Util.slice(arguments,1)),i},this.apply=function(e,t){return _.each(r(e),function(e){Pride.Util.safeApply(e,t)}),i},_.isFunction(e)&&e.call(this)},Pride.Util.MultiSearch=function(e,t,i){var r={},n=this;this.searches=i,this.uid=e,this.set=function(e){return _.extend(r,e),_.each(i,function(t){t.set(e)}),n};var s=function(e,t){return function(){var r=Pride.Util.slice(arguments);return Pride.Util.safeApply(t,r),_.each(i,function(t){t[e].apply(t,r)}),n}};this.run=s("run"),this.nextPage=s("nextPage"),this.prevPage=s("prevPage"),this.setMute=s("setMute",function(e){t=e}),this.getMute=function(){return t},this.setMute(t)},Pride.Util.Paginater=function(e){this.set=function(e){if(_.has(e,"total_pages"))throw"Can not set total_pages (it is a calculated value)";if(_.has(e,"index_limit"))throw"Can not set index_limit (it is a calculated value)";if(_.intersection(["start","end","count"],_.keys(e)).length>2)throw"Can not set start, end and count all at the same time";if(_.has(e,"page")&&(_.has(e,"start")||_.has(e,"end")))throw"Can not set page as well as the start and/or end";if(_.extend(t,_.omit(e,"end")),_.has(e,"page")&&(t.start=(t.count||0)*(t.page-1)),_.has(e,"end")){if(_.has(e,"count"))t.start=Math.max(e.end,e.end-(t.count-1));else{if(!(t.start<=e.end))throw"The start value can not be greater than the end value";t.count=e.end-t.start+1}t.end=e.end}else{var i=t.start+t.count-1;t.end=i<t.start?void 0:i}if(_.isNumber(t.total_available)?t.total_available>0?t.index_limit=t.total_available-1:t.index_limit=void 0:t.index_limit=1/0,t.count>0&&t.start%t.count===0?(t.page=Math.floor(t.start/t.count)+1,_.isNumber(t.total_available)?(t.total_pages=Math.ceil(t.total_available/t.count),t.page_limit=t.total_pages):(t.total_pages=void 0,t.page_limit=1/0)):(t.page=void 0,t.total_pages=void 0,t.page_limit=void 0),!_.has(t,"start")||!_.has(t,"count"))throw"Not enough information given to create Paginater";return this},this.get=function(e){return t[e]};var t={};this.set(e)},Pride.Util.Paginater.getPossibleKeys=function(){return["start","count","end","page","index_limit","total_pages","total_available","page_limit"]},Pride.Util.Paginater.hasKey=function(e){return Pride.Util.Paginater.getPossibleKeys().indexOf(e)>-1},Pride.Core.Query=function(e){var t=new Pride.Util.Paginater({start:e.start,count:e.count}),i=Pride.Util.Paginater.getPossibleKeys();e=_.omit(Pride.Util.deepClone(e),i),e.request_id=e.request_id||0,this.get=function(i){return Pride.Util.Paginater.hasKey(i)?t.get(i):e[i]},this.set=function(r){var n=_.pick(r,i),s=_.omit(r,i);return _.isEmpty(s)||(t.set({total_available:void 0}),_.isNumber(s.request_id)||(e.request_id+=1)),t.set(n),_.extend(e,s),this},this.clone=function(){var i=Pride.Util.deepClone(e);return i.start=t.get("start"),i.count=t.get("count"),new Pride.Core.Query(i)},this.toSection=function(){return new Pride.Util.Section(this.get("start"),this.get("end"))},this.toLimitSection=function(){return new Pride.Util.Section(this.get("start"),this.get("index_limit"))},this.toJSON=function(){return{uid:this.get("uid"),request_id:this.get("request_id"),start:this.get("start"),count:this.get("count"),field_tree:this.get("field_tree"),facets:this.get("facets"),sort:this.get("sort"),settings:this.get("settings")}}},Pride.Core.Record=function(e){var t=new Pride.Util.RequestBuffer({url:e.source,failure_message:Pride.Messenger.preset("failed_record_load",e.names[0]),edit_response:function(t){return e=r(t.results[0])}});this.renderPart=function(e){i(e)},this.renderPartThenCache=function(e){i(e),t.request()},this.renderFull=function(r){i(r),e.complete||t.request({success:r})};var i=function(t){t(_.omit(e,"complete","source"),e.complete)},r=function(e){return e.fields=_.map(e.fields,function(e){return e.value_has_html||(e.value=Pride.Util.escape(e.value)),_.omit(e,"value_has_html")}),e.names_have_html||(e.names=_.map(e.names,function(e){return Pride.Util.escape(e)})),_.omit(e,"names_have_html")};e=r(e)},Pride.Util.RequestBuffer=function(e){e=e||{};var t,i=new Pride.Util.FuncBuffer,r=!1,n=!1,s=!1;this.request=function(e){i.add(e.success,"success").add(e.failure,"failure"),r?a():u()};var a=function(e){t=e||t,n?o("success"):s&&o("failure")},u=function(){r=!0,Pride.Util.request({url:Pride.Util.safeCall(e.url),attempts:Pride.Util.safeCall(e.attempts)||Pride.Settings.connection_attempts,failure_message:Pride.Util.safeCall(e.failure_message),failure:function(t){s=!0,Pride.Util.safeCall(e.before_failure,t),a(t),Pride.Util.safeCall(e.after_failure,t)},success:function(t){n=!0,Pride.Util.safeCall(e.before_success,t),_.isFunction(e.edit_response)&&(t=e.edit_response(t)),a(t),Pride.Util.safeCall(e.after_success,t)}})},o=function(e){i.call(e,t).clearAll()}},Pride.Core.SearchBase=function(e,t){this.datastore=e.datastore,this.query=e.query||this.datastore.baseQuery();var i=this,r=e.requestFunc||this.datastore.runQuery,n=e.starting_results||[],s=e.cache_size||Pride.Settings.cache_size[this.datastore.uid]||Pride.Settings.default_cache_size;this.log=function(){var e=Pride.Util.slice(arguments);e.unshift("Search ("+i.datastore.get("uid")+")"),Pride.Core.log.apply(window,e)},this.set=function(e){return i.query.set(e),Pride.Util.safeCall(i.setDataChanged),_.isEmpty(_.omit(e,Pride.Util.Paginater.getPossibleKeys()))||(n=[]),i},this.run=function(e){return Pride.Util.safeCall(i.resultsChanged),_.isUndefined(e)&&(e=s),a(l(i.query.toSection().expanded(e))),i},this.results=function(){return d(new Pride.Util.Section(i.query.get("start"),Math.min(i.query.get("end"),i.query.get("index_limit"))))};var a=function(e){if(i.log("REQUESTING",e),i.log("TOTAL AVAILABLE (pre-request)",i.query.get("total_available")),e&&i.query.toLimitSection().overlaps(e)){i.log("Sending query...");var t=i.query.clone().set({start:e.start,count:e.calcLength()});r({query:t,failure_message:Pride.Messenger.preset("failed_search_run",i.datastore.get("metadata").name),success:function(r){if(r.request.request_id==i.query.get("request_id")){o(r),u(r.response,t.get("start"));var n=r.response.length;0!==n&&n<t.get("count")&&a(e.shifted(n,0))}}})}else Pride.Util.safeCall(i.runDataChanged)},u=function(e,t){var r=!1;i.log("NEW RECORDS",e),_.each(e,function(e,s){var a=s+t;_.isUndefined(n[a])&&(n[a]=Pride.Util.safeCall(i.createItem,e),i.query.toSection().inSection(a)&&(r=!0))}),i.log("CACHE LENGTH",n.length),(r||_.isEmpty(e))&&Pride.Util.safeCall(i.resultsChanged)},o=function(e){i.datastore.update(e.datastore);var t=_.omit(e.new_request,"start","count");t.total_available=e.total_available,i.query.set(t),Pride.Util.safeCall(i.runDataChanged)},l=function(e){var t=d(e),i=_.indexOf(t,void 0);if(-1!=i){var r=e.start+_.lastIndexOf(t,void 0);return i+=e.start,new Pride.Util.Section(i,r)}},d=function(e){for(var t=[],i=e.start;i<=e.end;i++)t.push(n[i]);return t},c=!1,h=[],f=[];this.clearAllObservers=function(){return _.each(h,function(e){e.clearAll()}),Pride.Util.safeCall(i.initialize_observables),i},this.getMute=function(){return c},this.setMute=function(e){return e!=c&&(c=e,Pride.Util.safeCall(i.muteChanged()),c||_.each(f,function(e){e.notify()})),i},this.createObservable=function(e,t,r){var n=new Pride.Util.FuncBuffer(function(){var n=this.add,s=this.call;h.push(this),r||f.push(this),this.add=function(e){return(!i.muted||r)&&e(t()),n(e,"observers"),this},this.notify=function(){return(!i.muted||r)&&(data=t(),i.log("NOTIFY ("+e+")",data),s("observers",data)),this}});return i[e+"Changed"]=n.notify,n},this.muteObservers=this.createObservable("mute",this.getMute,!0),t.set=function(e){return i.set(e),t},t.run=function(e){return i.run(e),t},t.nextPage=function(e){var r=i.query.get("page");return _.isNumber(r)&&r<i.query.get("page_limit")&&(t.set({page:r+1}),t.run(e)),t},t.prevPage=function(e){var r=i.query.get("page");return _.isNumber(r)&&r>1&&(t.set({page:r-1}),t.run(e)),t}},Pride.Util.SearchSwitcher=function(e,t){var i=this,r=new Pride.Util.MultiSearch(null,!0,t);e.set({page:1}).setMute(!1),r.set({page:1}),this.uid=e.uid,this.run=function(t){return e.run(t),r.run(0),i},this.set=function(t){return e.set(t),r.set(_.omit(t,"page","facets")),i},this.nextPage=function(){return e.nextPage(),i},this.prevPage=function(){return e.prevPage(),i},this.switchTo=function(t){if(t!=e){if(e.setMute(!0).set({page:1}),r.searches.push(e),e=void 0,r.searches=_.reject(r.searches,function(i){return i.uid==t?(e=i,!0):void 0}),!e)throw"Could not find a search with a UID of: "+t;i.uid=e.uid,e.setMute(!1)}return i}},Pride.Util.Section=function(e,t){this.start=Math.max(Math.min(e,t),0),this.end=Math.max(Math.max(e,t),0),this.inSection=function(e){return e>=this.start&&e<=this.end},this.overlaps=function(e){return this.inSection(e.start)||this.inSection(e.end)},this.calcLength=function(){return this.end-this.start+1},this.expanded=function(e){return this.shifted(-1*e,e)},this.shifted=function(e,t){return _.isNumber(t)||(t=e),new Pride.Util.Section(this.start+e,this.end+t)},this.merge=function(){return arguments.push(this),new Pride.Util.Section(_.min(arguments,function(e){return e.start}),_.max(arguments,function(e){return e.end}))}},Pride.Util.deepClone=function(e){return _.isFunction(e)?e:(collection_function=!1,_.isArray(e)?collection_function="map":_.isObject(e)&&(collection_function="mapObject"),collection_function?_[collection_function](e,function(e){return Pride.Util.deepClone(e)}):_.clone(e))},Pride.Util.escape=function(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML},Pride.init=new Pride.Util.RequestBuffer({url:function(){return Pride.Settings.datastores_url},attempts:function(){return Pride.Settings.init_attempts},failure_message:function(){return Pride.Messenger.preset("failed_init")},edit_response:function(){},before_success:function(e){Pride.AllDatastores.array=_.map(e.response,function(e){return new Pride.Core.Datastore(e)})}}).request,Pride.Util.isDeepMatch=function(e,t){var i=_.isArray(e)&&_.isArray(t),r=_.isObject(e)&&_.isObject(t);return i&&t.length!=e.length?!1:r&&_.keys(t).length!=_.keys(e).length?!1:i&&r?_.every(t,function(t,i){return Pride.Util.isDeepMatch(e[i],t)}):e===t},Pride.Core.log=function(e,t){if(Pride.Settings.obnoxious){var i=Pride.Util.slice(arguments,2);i.unshift("[Pride: "+e+"] "+t),console.log.apply(console,i)}},Pride.FieldTree.parseField=function(e,t){return t?new Pride.FieldTree.Field(e,new Pride.FieldTree.Literal(t)):{}},Pride.Util.request=function(e){if(Pride.Core.log("Request","Sending HTTP request..."),Pride.Core.log("Request","URL",e.url),Pride.Core.log("Request","CONTENT",JSON.stringify(e.query)),!e.url)throw"No URL given to Pride.Util.request()";var t="get";e.query&&(t="post"),_.isNumber(e.attempts)||(e.attempts=Pride.Settings.connection_attempts),e.attempts-=1,reqwest({url:e.url,data:JSON.stringify(e.query),type:"json",method:t,contentType:"application/json",withCredentials:!0,error:function(t){e.attempts<=0?(Pride.Core.log("Request","ERROR",t),Pride.Util.safeCall(e.failure,t),Pride.Messenger.sendMessage({summary:e.failure_message,"class":"error"})):(Pride.Core.log("Request","Trying request again..."),window.setTimeout(function(){Pride.Util.request(e)},Pride.Settings.ms_between_attempts))},success:function(t){Pride.Core.log("Request","SUCCESS",t),Pride.Util.safeCall(e.success,t),Pride.Messenger.sendMessage({summary:e.success_message,"class":"success"}),Pride.Messenger.sendMessageArray(t.messages)}})},Pride.Util.safeCall=function(e){return _.isFunction(e)?e.apply(this,Pride.Util.slice(arguments,1)):e},Pride.Util.safeApply=function(e,t){return _.isFunction(e)?e.apply(this,t):e},Pride.Util.slice=function(e,t,i){return Array.prototype.slice.call(e,t,i)},Pride.AllDatastores={array:[],newSearch:function(e){var t=_.find(this.array,function(t){return t.get("uid")==e});return t?t.baseSearch():void 0},each:function(e){return _.each(this.array,e),this}},Pride.Messenger=new Pride.Util.FuncBuffer(function(){this.call;this.addObserver=this.add,this.removeObserver=this.remove,this.clearObservers=this.clear,this.call=void 0,this.add=void 0,this.remove=void 0,this.clear=void 0,this.sendMessage=function(e){},this.sendMessageArray=function(e){},this.preset=function(e){}});